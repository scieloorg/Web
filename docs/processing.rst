==========
Processing
==========

Generating the databases for SciELO website
===========================================

Directories
-----------

    .. image:: img/en/scieloweb-dir.png

The *bases-work* subdirectory hosts the sub-directories of each database during 
processing in addition to individual directories for each journal. 

The *serial* subdirectory contains the directories of all journals which in turn have 
all the original numbers used in processing (this data may be discarded after 
processing is carried out and approved). 

The *bases* subdirectory has the databases for the website.
   
    .. image:: img/en/scieloweb-bases.png

The *proc* subdirectory has the processing scripts, and other files related to the processing.


GeraPadrao.bat
--------------
It is a script which generates the databases for the SciELO website.

- INPUTS: 
    - serial folder's content:
        - databases generated by Converter from markup and body folders and were sent to the Linux server by EnviaBasesScieloPadrao.bat script of the local server.
        - scilista.lst which contains a list of journal issues to be add/replaced/deleted.
    - folders and files located in /var/www/scielo/bases-work/
    - log filename. e.g.: /var/www/scielo/proc/log/GeraPadrao.log

- OUTPUTS:
    - folders and files located in /var/www/scielo/bases-work/
    - folders and files located in /var/www/scielo/bases/
    - log file. e.g.: /var/www/scielo/proc/log/GeraPadrao.log
    
Edit GeraPadrao.bat to set parameters to generate the website's databases.

    .. code-block:: text

        ./GeraScielo.bat <serial_parent_path> <proc_parent_path> <log filename> <cria>

where

    - Parameter 1: serial_parent_path: e.g.: /var/www/scielo/
    - Parameter 2: proc_parent_path:   e.g.: /var/www/scielo/
    - Parameter 3: log filename:  e.g.: /var/www/scielo/proc/log/GeraPadrao.log
    - Parameter 4: optional parameter. Use the value cria, if you want to reset the log file, otherwise, the log file will be appended.


    .. warning:: 
        It is possible to use relative paths for parameters 1 to 3.


Examples: 

    .. code-block:: text

        ./GeraScielo.bat .. .. log/GeraPadrao.log

    .. code-block:: text

        ./GeraScielo.bat .. .. log/GeraPadrao.log cria

Execute GeraPadrao.bat

Go to /var/www/scielo/proc

Edit/check scilista.lst which contains the list of journal issues of the website.

    .. code-block:: text

       vi ../serial/scilista.lst


Execute 

    .. code-block:: text

       ./GeraPadrao.bat


Exporting the databases for SciELO Network processing
=====================================================

This process is made through the utilitary **Paperboy**. Paperboy is a 
Python utilitary developed to replace the scripts:

    * Envia2MedlinePadrao.bat
    * static_files_catalog.sh

Installing
----------

Install guide: https://github.com/scieloorg/paperboy


Configuring
-----------

After install the paperboy you must create a config.ini file to configure the
source and destiny resources, and the ssh account that will be used to send data
to the server.


Creating config.ini file
````````````````````````

Access the directory /var/www/scielo/proc

.. code-block:: text

    cd /var/www/scielo/proc

Create a text file named **paperboy_envia_to_scielo_config.ini** in the **proc**
directory, the file must follow the bellow format:

.. note::

    You may also use a file name of your preference for the config file, having
    in mind you must to replace the name of the config file in the following
    guidances.

.. code-block:: text

    [app:main]
    source_dir=c:/var/www/scielo
    cisis_dir=c:/var/www/scielo/proc/cisis
    ssh_server=localhost
    ssh_port=22
    ssh_user=anonymous
    ssh_password=anonymous

**source_dir:** Absolute path to the directory where the SciELO website was installed.

**cisis_dir:** Absolute path to the directory where CISIS utilitary was installed

**ssh_server:** Domain of the server where the SciELO Site was installed

**ssh_port:** The SSH port (default 22)

**ssh_user:** A valid SSH username 

**ssh_password:** A valid SSH password for the given username

.. tip::

    Ask your SSH credentials to the SciELO team.

Creating envia.bat file
```````````````````````

Create a text file named **paperboy_envia_to_scielo.bat** in the **proc**
directory.

.. note::

    You may also use a file name of your preference for the batch file, having
    in mind you must to replace the name of the config file in the following
    guidances.

The content of the .bat file must be::

    set PAPERBOY_SETTINGS_FILE=/var/www/scielo/proc/paperboy_envia_to_scielo_config.ini
    paperboy -m -o /var/www/scielo/proc/log/paperboy_envia_to_scielo_config.log

Running
-------

Run the script **paperboy_envia_to_scielo_config.bat** to send databases and 
reports to SciELO.

.. code-block:: text

    paperboy_envia_to_scielo_config.bat


Notes
`````

* Ask the SciELO team for you SSH credentials.
* You must configure a **CRON** to run periodically the processing. (Preferable Weekly or after all the database updates)
* The log files are:
    * /var/www/scielo/proc/log/paperboy_envia_to_scielo_config.log
