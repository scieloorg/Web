<!-- Common Functions (SciELO Interface)-->
<include>ScieloXML/sci_getdefine.xis</include>
<include>ScieloXML/sci_journal.xis</include>
<!-- ============================================================================ -->
<!--  function GetLastRegularIssue                                                       -->
<!--                                                                              -->
<!--  Gets the pid (issnyyyynnnn) of the last issue of a serial.                  -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issn) of the serial.                                            -->
<!--                                                                              -->
<!--  Return value:                                                               -->
<!--     If found, returns the pid of the last issue of the serial in the tag     -->
<!--  7090. Otherwise, returns nothing.                                           -->
<!-- ============================================================================ -->
<function name="GetLastRegularIssue" action="replace" tag="4900">
	<display><pft>'<!-- (issn) v4900 = ',v4900,' -->',#</pft></display>

	<do task="keyrange">
		<parm name="db">ARTIGO</parm>
		<parm name="from"><pft>'Y',v4900,'zzzz'</pft></parm>
		<parm name="reverse">On</parm>
		
		<field action="define" tag="4901">Isis_Key</field>
		
		<loop>
			<field action="import" tag="list">4900</field>			
			<field action="replace" tag="7090" >
				<pft>
					if instr(v4901,v4900) = 0 then, /* there is no last issue */ ,
						,'NONE',
					else
						if l(['NEWISSUE'],v4901) > 0 then
							,if ref(['NEWISSUE']l(['NEWISSUE'],v4901), if v32<>'ahead' and v32<>'review' and v41='' then 'regular' fi) = 'regular' then
								,v4901*1, 
							,fi
						fi
					fi
				</pft>
			</field>
			<field action="export" tag="list"><pft>if p(v7090) then '7090' fi</pft></field>	
			<flow action="skip"><pft>if p(v7090) then 'Quit' fi</pft></flow>
						
		</loop>
		<field action="export" tag="list">7090</field>
	</do>
	<display><pft>'<!-- last regular issue=',v7090,' -->'</pft></display>
	
	<return action="replace" tag="7090">
		<pft>
			v7090
		</pft>
	</return>

</function>

<!-- ============================================================================ -->
<!--  function GetPreviousIssue                                                   -->
<!--                                                                              -->
<!--  Gets the pid (issnyyyynnnn) of the previous issue of a given issue pid.     -->
<!--                                                                              -->
<!--  Arguments:                                                                   -->
<!--     The pid (issnyyyynnnn) of an issue.                                      -->
<!--     ^t type of the given issue (REGULAR, ahead, review) -->
<!--                                                                              -->
<!--  Return value:                                                               -->
<!--     If found, returns the pid of the previous issue in the tag 7085.         -->
<!--  Otherwise, returns nothing.                                                 -->
<!--  Note:                                                                       -->
<!--  If it is a ahead of print issue, the previous issue is the last regular issue -->
<!--  Otherwise any previous issue but any ahead of print                         -->
<!-- ============================================================================ -->
<function name="GetPreviousIssue" action="replace" tag="4900">
	<display><pft>'<!-- v4900 (issue pid) = ',v4900,' -->',#</pft></display>
	
	<field action="replace" tag="4910"><pft>v4900^t</pft></field>
	<field action="replace" tag="4900"><pft>v4900^*</pft></field>
	
	<!-- given issue is ahead or review? -->
	<field action="replace" tag="4910"><pft>if a(v4910) then ref(['NEWISSUE']l(['NEWISSUE'],'Y',v4900), if v32='ahead' or v32='review' then v32 fi)  fi</pft></field>
	
	
	<flow action="jump"><pft>'given_issue_is_',v4910</pft></flow>
	
	<label>given_issue_is_review</label>
	<call name="GetNotPrintedIssuePID"><pft>'^a',v4900*0.9,'^bAHEAD'</pft></call>
	<field action="replace" tag="7085"><pft>v7095^*[1]</pft></field>
	<field action="delete" tag="list">7095</field>
	<flow action="jump"><pft>if p(v7085) then 'DONE'  fi</pft></flow>
	
	<label>given_issue_is_ahead</label>
	<call name="GetLastRegularIssue"><pft>v4900*0.9</pft></call>
	<field action="replace" tag="7085"><pft>v7090</pft></field>
	<flow action="jump"><pft>if p(v7085) then 'DONE'  fi</pft></flow>
	
	<label>given_issue_is_LAST</label>
	<label>given_issue_is_</label>
	<do task="keyrange">
		<parm name="db">ARTIGO</parm>
		<parm name="from"><pft>'Y',v4900</pft></parm>
		<parm name="reverse">On</parm>
		
		<field action="define" tag="4901">Isis_Key</field>
		
		<loop>
			<display><pft>'<!-- ',v4901,' -->'/</pft></display>
			<field action="import" tag="list">4900,4910</field>
			<field action="replace" tag="7085">
				<pft>
					if v4900=v4901*1 then
					     /* it is the given issue, execute a new loop */
					     
					,else
					    ,if instr(v4901,s(v4900*0.9))>0 then
						    ,if l(['NEWISSUE'],v4901) > 0 then
								,if ref(['NEWISSUE']l(['NEWISSUE'],v4901), if v32<>'ahead' and v32<>'review' and v41='' then 'regular' fi) = 'regular' then
									,v4901*1, 
								,fi
							,fi
						,else
						     ,'FINISH'
					    ,fi
					,fi 
				</pft>
			</field>
			
			<field action="export" tag="list">7085</field>
			<flow action="skip"><pft>if p(v7085) then 'Quit' fi</pft></flow>
		</loop>	
	</do>	
	<label>DONE</label>
	<return action="replace" tag="7085"><pft>if v7085<>'FINISH' then v7085 fi</pft></return>
	
</function>
<!-- ============================================================================ -->
<!--  function GetNextIssue                                                       -->
<!--                                                                              -->
<!--  Gets the pid (issnyyyynnnn) of the next issue of a given issue.         -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issnyyyynnnn) of a given issue.                             -->
<!--                                                                              -->
<!--  Return value:                                                               -->
<!--     If found, returns the pid of the next issue in the tag 7095. Otherwise   -->
<!--  returns nothing.                                                            -->
<!-- ============================================================================ -->
<function name="GetNextIssue" action="replace" tag="4900">
	<display><pft>'<!-- v4900 (issue pid) = ',v4900,' -->',#</pft></display>
	
	<field action="replace" tag="4910"><pft>v4900^t</pft></field>
	<field action="replace" tag="4900"><pft>v4900^*</pft></field>
	
	<!-- given issue is ahead or review? -->
	<field action="replace" tag="4910"><pft>if a(v4910) then ref(['NEWISSUE']l(['NEWISSUE'],'Y',v4900), if v32='ahead' or v32='review' then v32 fi)  fi</pft></field>
	
	
	
	<flow action="jump"><pft>'given_issue_is_',v4910</pft></flow>
	
	<label>given_issue_is_review</label>
	<flow action="jump">DONE</flow>
	
	
	<label>given_issue_is_</label>
	<call name="GetLastRegularIssue"><pft>v4900*0.9</pft></call>
	<flow action="jump"><pft>if v7090=v4900 then 'given_issue_is_LAST' fi</pft></flow>
	
	<do task="keyrange">
		<parm name="db">ARTIGO</parm>
		<parm name="from"><pft>'Y',v4900</pft></parm>
		
		<field action="define" tag="4901">Isis_Key</field>
		<loop>
			<field action="import" tag="list">4900,4910</field>
			<field action="replace" tag="7095">
				<pft>
					if v4900=v4901*1 then
					     /* it is the given issue, execute a new loop */
					     
					,else
					    ,if instr(v4901,s(v4900*0.9))>0 then
						    ,if l(['NEWISSUE'],v4901) > 0 then
								,if ref(['NEWISSUE']l(['NEWISSUE'],v4901), if v32<>'ahead' and v32<>'review' and (v41='' or a(v41)) then 'regular' fi) = 'regular' then
									,v4901*1, 
								,fi
							,fi
						,else
						     ,'FINISH'
					    ,fi
					,fi 
				</pft>
			</field>
			
			<field action="export" tag="list">7095</field>
			<flow action="skip"><pft>if p(v7095) then 'Quit' fi</pft></flow>
		</loop>	
	</do>	
	<flow action="jump"><pft>if p(v7095) then 'DONE' fi</pft></flow>
	
	
	<label>given_issue_is_LAST</label>
	<call name="GetNotPrintedIssuePID"><pft>'^a',v4900*0.9,'^bAHEAD'</pft></call>
	<field action="replace" tag="7095"><pft>v7095^*[1]</pft></field>
	<flow action="jump"><pft>if p(v7095) then 'DONE' fi</pft></flow>
	
	<label>given_issue_is_ahead</label>
	<call name="GetNotPrintedIssuePID"><pft>'^a',v4900*0.9,'^bREVIEW'</pft></call>
	<field action="replace" tag="7095"><pft>v7095^*[1]</pft></field>
	<flow action="jump">DONE</flow>
	
	
	
	<label>DONE</label>
	<return action="replace" tag="7095"><pft>if v7095<>'FINISH' then v7095 fi</pft></return>
	
		
</function>

<!-- ============================================================================ -->
<!--  function GetNotPrintedIssuePID                                  -->
<!--                                                                              -->
<!--  Gets the pid (issnyyyynnnn) of an issue with special characteristics,       -->
<!--            which can be ahead or review, or ...                              -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--   v4900^a :   The ISSN of the title.										  -->
<!--   v4900^b :   the prefix: AHEAD or REVIEW									  -->
<!--                        -->
<!--  Return value:                                                               -->
<!--     If found, returns the pid of an issue with special characteristics       -->
<!--     in the tag 7095 and ^f if it has articles. Otherwise  returns nothing.   -->
<!--																	          -->
<!-- ============================================================================ -->
<function name="GetNotPrintedIssuePID" action="replace" tag="4900">
	<!--display><pft>'v4900 = ',v4900,'<br>'</pft></display-->
	
	<do task="search">
		<parm name="db">ARTIGO</parm>
		<parm name="expression"><pft>v4900^b,'='v4900^a</pft></parm>		
		<loop>			
			<field action="import" tag="list">4903</field>
			<field action="import" tag="list">4900</field>
			<field action="import" tag="list">5001</field>
			<field action="replace" tag="9936">
				<pft>@PROC_SPLIT_MST.PFT,
					f(val(v36*4.3)+10000,2,0)</pft>
			</field>
			<field action="replace" tag="4901">
				<pft>@PROC_SPLIT_MST.PFT,
					v35,v65*0.4,v9936*1.4</pft>
			</field>
			<field action="delete" tag="list">4902</field>
			<do task="search">
			   <parm name="db">ARTIGO</parm>
			   <parm name="expression"><pft>'SM='v4901,'$'</pft></parm>
			   <parm name="count">1</parm>
			   <loop>
					<field action="replace" tag="4902"><pft>v880</pft></field>
					<field action="export" tag="list">4902</field>
				</loop>	
			</do>	
			<!--field action="add" tag="4903"><pft>v4901,if p(v4902) then '^f1' fi,'^t'v4900^b</pft></field-->

			<field action="replace" tag="5000"><pft>if p(v4902) then v4901,'^f1','^t'v4900^b fi</pft></field>
			<field action="replace" tag="5001"><pft>if a(v5001) then v5000 fi</pft></field>
			<field action="add" tag="4903"><pft>v5000</pft></field>
			
			<field action="replace" tag="5001"><pft>if p(v5000) then if val(v5000*9.4)>val(v5001*9.4) then v5000 else v5001 fi fi</pft></field>
			<display><pft>'<!-- ',v5000*9.4, ' ',v5001*9.4,' -->'</pft></display>
			<field action="export" tag="list">4903,5001</field>
		</loop>	
	</do>
	<!-- em v5001 = ahead/review com data mais recente -->
	<return action="replace" tag="7095"><pft>v5001/,(if v4903<>v5001[1] then v4903/ fi)</pft></return>
		
</function>
<!-- ============================================================================ -->
<!--  function GetNotPrintedIssues                                                       -->
<!--                                                                              -->
<!--  Gets the pid (issnyyyynnnn) of all the not printed issues of a serial.                  -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issn) of the serial.                                            -->
<!--                                                                              -->
<!--  Return value:                                                               -->
<!--     If found, returns all the not printed issues of a serial in the tag     -->
<!--  3900. Otherwise, returns nothing.                                           -->
<!-- ============================================================================ -->
<function name="GetNotPrintedIssues" action="replace" tag="4900">
	<!--display><pft>'v4900 = ',v4900,'<br>'</pft></display-->

	<call name="GetNotPrintedIssuePID"><pft>'^a',v4900,'^bREVIEW'</pft></call>
	<field action="add" tag="3900" split="occ"><pft>(v7095/)</pft></field>
	<field action="delete" tag="7095">1</field>

	<call name="GetNotPrintedIssuePID"><pft>'^a',v4900,'^bAHEAD'</pft></call>
	<field action="add" tag="3900" split="occ"><pft>(v7095/)</pft></field>

	<field action="export" tag="3900">3900</field>
</function>


<!-- ============================================================================ -->
<!--  function GetPreviousArticle                                                 -->
<!--                                                                              -->
<!--  Gets the pid (issnyyyynnnnaaaaa) of the previous article of the current     -->
<!--  article.                                                                    -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issnyyyynnnnaaaaa) of the current article.                      -->
<!--                                                                              -->
<!--  Return value:                                                               -->
<!--     If found, returns the pid of the previous article in the tag 7085.       -->
<!--  Otherwise, returns nothing.                                                 -->
<!-- ============================================================================ -->
<function name="GetPreviousArticle" action="replace" tag="4900">
	<!--display><pft>'v4900 = ',v4900,'<br>'</pft></display-->
	<field action="replace" tag="5000"><pft>v4900^x</pft></field>
	<field action="replace" tag="4900"><pft>'SM=',s(v4900^*)*1.17,'-',s(v4900^*)*18</pft></field>

	<do task="keyrange">
		<parm name="db">ARTIGO</parm>
		<parm name="from"><pft>v4900</pft></parm>
		<!--parm name="count">2</parm-->
		<parm name="reverse">On</parm>

		<field action="define" tag="4901">Isis_Key</field>
		
		<loop>
			<field action="import" tag="4900">4900</field>
			<display><pft>'<!-- '/,'from:',v4900/</pft></display>
			<display><pft>'curr: ',v4901/,'-->'/</pft></display>

			<flow action="skip">
				<pft>
					/* The first key found whose pid isn't the current article's  */
					/* pid stops the loop.                                        */
					/* if article has new-pid (v222) then execute next loop       */
					if ref(['ARTIGO']l(['ARTIGO'],v4901),@PROC_SPLIT_MST.PFT,v222)='' then 
						if p(v4901) and instr(v4901,v4900) = 0 then 'Quit' fi
					fi
				</pft>
			</flow>
		</loop>	
	</do>	

	<display><pft>'Isis_Key (v4901): ', v4901/</pft></display>
	<display><pft>'Isis_Key (v4900): ', v4900/,v4900*0.21/</pft></display>
	
	<field action="replace" tag="7085">
		<pft>
			/* The pid of the key must be different from the pid of the current issue */
			/* and the issue must be equal.                                           */
			if p(v4901) and
			   instr(v4901, v4900) = 0 and 
			   instr(v4901, v4900*0.21) > 0 then,
 				,v4901*3,
			fi,
		</pft>
	</field>
    <display><pft>,v4901*3/,,'Isis_Key (v7085): ', v7085,/</pft></display>
	
	<flow action="jump"><pft>if p(v7085) or a(v5000) then 'FOUND_PREV_ARTICLE' fi</pft></flow>
	<field action="replace" tag="4900"><pft>|SM=|v5000*1</pft></field>
	<do task="keyrange">
		<parm name="db">ARTIGO</parm>
		<parm name="from"><pft>v4900,'zzz'</pft></parm>
		<parm name="reverse">On</parm>
		<parm name="count">1</parm>

		<field action="define" tag="4901">Isis_Key</field>
		
		<loop>
			<field action="import" tag="4900">4900</field>
			<display><pft>'<!-- ',v4900/</pft></display>
			<display><pft>'left(v4900, size(v4900) - 5)',left(v4900, size(v4900) - 5)/</pft></display>
			<display><pft>v4901,'-->'/</pft></display>
			<field action="replace" tag="5001">
				<pft>
					if p(v4901) then
						,if instr(v4901, left(v4900, size(v4900) - 5)) > 0 then,
							,mid(v4901*3, 1, 23),
						,fi
					fi,
				</pft>
			</field>
			<field action="export" tag="5001">5001</field>
		</loop>	
	</do>	
	<field action="replace" tag="7085"><pft>v5001</pft></field>
	<label>FOUND_PREV_ARTICLE</label>
	<field action="replace" tag="7085"><pft>if p(v7085) then 'S',mid(v7085,1,17),v7085*18 fi</pft></field>

	<return action="replace" tag="7085"><pft>v7085</pft></return>
</function>

<!-- ============================================================================ -->
<!--  function GetNextArticle                                                     -->
<!--                                                                              -->
<!--  Gets the pid (issnyyyynnnnaaaaa) of the next article of the current article.-->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issnyyyynnnnaaaaa) of the current article.                      -->
<!--                                                                              -->
<!--  Return value:                                                               -->
<!--     If found, returns the pid of the next article in the tag 7095. Otherwise -->
<!--  returns nothing.                                                            -->
<!-- ============================================================================ -->
<function name="GetNextArticle" action="replace" tag="4900">
	<!--display><pft>'v4900 = ',v4900,'<br>'</pft></display-->

	<field action="replace" tag="5000"><pft>v4900^x</pft></field>
	<field action="replace" tag="4900"><pft>'SM=',s(v4900^*)*1.17,'-',s(v4900^*)*18</pft></field>
	<do task="keyrange">
		<parm name="db">ARTIGO</parm>
		<parm name="from"><pft>v4900,'zzzzz'</pft></parm>
		<!--parm name="count">1</parm-->
		
		<field action="define" tag="4901">Isis_Key</field>
		
		<loop>
			<field action="import" tag="4900">4900</field>
			<display><pft>'<!-- '/,'from:',v4900/</pft></display>
			<display><pft>'curr: ',v4901/,'-->'/</pft></display>
			<flow action="skip">
				<pft>
					/* The first key found whose pid isn't the current article's  */
					/* pid stops the loop.                                        */
					/* if article has new-pid (v222) then execute next loop       */
					if ref(['ARTIGO']l(['ARTIGO'],v4901),@PROC_SPLIT_MST.PFT,v222)='' then 
						if p(v4901) and instr(v4901,v4900) = 0 then 'Quit' fi
					fi
				</pft>
			</flow>
		</loop>	
	</do>	
	<!--display><pft>'Isis_Key (v4901): ', v4901,'<br>'</pft></display-->
	
	<field action="replace" tag="7095">
		<pft>
			/* The pid of the key must be different from the pid of the current article */
			/* and the issue must be equal.                                             */
			if p(v4901) and ref(['ARTIGO']l(['ARTIGO'],v4901),@PROC_SPLIT_MST.PFT,v222)='' and
			   instr(v4901, v4900) = 0 and
			   instr(v4901, left(v4900, size(v4900) - 5)) > 0 then,
 				,mid(v4901*3, 1, 23),				
			fi,
		</pft>
	</field>
	<!--display><pft>'Isis_Key (v7095): ', v7095,'<br>'</pft></display-->

	<flow action="jump"><pft>if p(v7095) or a(v5000) then 'FOUND_NEXT_ARTICLE' fi</pft></flow>
	<field action="replace" tag="4900"><pft>|SM=|v5000*1</pft></field>
	<do task="keyrange">
		<parm name="db">ARTIGO</parm>
		<parm name="from"><pft>v4900</pft></parm>
		<parm name="count">1</parm>

		<field action="define" tag="4901">Isis_Key</field>
		
		<loop>
			<field action="import" tag="4900">4900</field>
			<display><pft>'<!-- '/,'from:',v4900/</pft></display>
			<display><pft>'curr: ',v4901/,'-->'/</pft></display>
			<field action="replace" tag="5001">
				<pft>
					/* The pid of the key must be different from the pid of the current article */
					/* and the ISSN must be equal.                                             */
					if p(v4901) then
						,if instr(v4901, left(v4900, size(v4900) - 5)) > 0 then,
							,mid(v4901*3, 1, 23),
						,fi
					fi,
				</pft>
			</field>
			<field action="export" tag="5001">5001</field>
		</loop>	
	</do>	
	<field action="replace" tag="7095"><pft>v5001</pft></field>
	<label>FOUND_NEXT_ARTICLE</label>
	<field action="replace" tag="7095"><pft>if p(v7095) then 'S',v7095*0.17,v7095*18 fi</pft></field>

	<return action="replace" tag="7095"><pft>v7095</pft></return>
		
</function>

<!-- Funcoes de sci_common.xis -->


<!-- ============================================================================ -->
<!--  function CreateControlInfoXML                                               -->
<!--                                                                              -->
<!--  Prints the xml control information.                                         -->
<!--                                                                              -->
<!--  Arguments:                                                                  -->
<!--     ^lLanguage^sStandard^pPID^tTarget^iInternational Language^fpage (from)   -->
<!--     where Target is      	                                                  -->
<!--	    'TIT' navigation in the issues but none either selected               -->
<!--	    'ISS' navigation in the issues but one issue already selected         -->
<!--	    'ART' navigation in the articles (Full-Text)                          -->
<!--	    'ABS' navigation in the articles (Abstract)                           -->
<!-- ============================================================================ -->
<function name="CreateControlInfoXML" action="replace" tag="4900">
	<field action="import" tag="list">7000/7070</field> <!-- fixed -->
	<field action="import" tag="list">3311</field> 
	<call name="checkNewHome"><pft>if p(v7047) and p(v3311) then '^u'v7047,'^r',v3311,'^l',v4900^l fi</pft></call>
	<field action="replace" tag="7047">
		<pft>if instr(v7047,'REPLACE_PARAM_')>0 then
			,replace(replace(replace(v7047,'REPLACE_PARAM_REP',v3311),'REPLACE_SERVER_SCIELO',v7009),'REPLACE_PARAM_LANG',v4900^l) fi
		</pft>
	</field>
	<field action="delete" tag="7047">
		<pft>if instr(v7047,v7009)>0 and instr(v7047,'sci_home')>0 then 'yes' fi</pft>
	</field>
	<display><pft>
		' <CONTROLINFO>'/,
		'  <DATETIME>',date,'</DATETIME>'/
		'  <LANGUAGE>',v4900^l,'</LANGUAGE>'/
		'  <STANDARD>',v4900^s,'</STANDARD>'/
		'  <PAGE_NAME>',v4900^f,'</PAGE_NAME>'/
		if p(v4900^p) then,
		'  <PAGE_PID>',v4900^p,'</PAGE_PID>'/,
		fi,
		'  <APP_NAME>',v7038,'</APP_NAME>'/,
		'  <SITE_NAME>',replace(v7001,'Scielo','SciELO'),'</SITE_NAME>'/,
		"  <ENABLE_STAT_LINK>"v7039"</ENABLE_STAT_LINK>"/,
		"  <ENABLE_CIT_REP_LINK>"v7040"</ENABLE_CIT_REP_LINK>"/,
		"  <ENABLE_COAUTH_REPORTS_LINK>"v7059"</ENABLE_COAUTH_REPORTS_LINK>"/,
		"  <NAVEGATION_TYPE>"v7048"</NAVEGATION_TYPE>"/,
		
		"  <NO_SCI_SERIAL>"v7046"</NO_SCI_SERIAL>"/,
		if p(v7047) then
		'  <NEW_HOME>',
					,replace(replace(v7047,'"',''),'&','&amp;') 
		'</NEW_HOME>'/,
		fi
		|<LICENSE>|v7051|</LICENSE>|

	</pft></display>
	
	<call name="CreatePathControlInfoXML">Now</call>
	<call name="GetNotPrintedIssues">
        <pft>
        if s(mpu,v4900^t,mpl) = 'ART' or s(mpu,v4900^t,mpl) = 'ABS' then,
            mid(v4900^p,2,9)
        else
            mid(v4900^p,1,9)
        fi
        </pft>
    </call>
    <display>
        <pft>
        if p(v3900) then
            '<FUTURE_ISSUES>',#
                (if v3900^f='1' then '<FUTURE_ISSUE PID="',v3900^*,'" NUM="',v3900^t,'"/>' fi/)
            '</FUTURE_ISSUES>',#
            fi
            </pft>
    </display>
	<call name="CreateIssuesNavButtonsForJournal">
		<pft>
			if a(v7048) then
			if s(mpu,v4900^t,mpl) = 'TIT' then 
				mpu,v4900^p,mpl 
			fi
			fi
		</pft>
	</call>

	<call name="CreatePreviousNextIssue">
		<pft>
			if a(v7048) then
			if s(mpu,v4900^t,mpl) = 'ISS' then 
				mpu,v4900^p,mpl 
			fi
			fi
		</pft>
	</call>
	
	<call name="CreateCurrentPreviousYear">
		<pft>
		if p(v7048) then
			if s(mpu,v4900^t,mpl) = 'TIT' then 
				mpu,v4900^p,mpl 
			fi
		fi
		</pft>
	</call>
	
	<call name="CreatePreviousNextYear">
		<pft>
			if p(v7048) then
				if s(mpu,v4900^t,mpl) = 'ISS' then 
					mpu,v4900^p,mpl 
				fi
			fi
		</pft>
	</call>


	<call name="CreatePreviousNextArticle">
		<pft>
			/* Pass ^pPid^lLanguage^iInternational Lang^tTarget type */
			if s(mpu,v4900^t,mpl) = 'ART' or s(mpu,v4900^t,mpl) = 'ABS' then, 
				'^p',mpu,v4900^p,mpl,'^l',v4900^l,'^i',v4900^i,'^t',v4900^t
			fi
		</pft>
	</call>
	<call name="CreatePDFLinkXML">
		<pft>
			if s(mpu,v4900^t,mpl) = 'PDF' then 
				v4900^u
			fi
		</pft>
	</call>
	<display><pft>' </CONTROLINFO>'/#</pft></display>
	

	<call name="getCreativeCommonsInfo"><pft>if v7051='cc' then '^l',v4900^l,'^f',v4900^l,'_',v4900^f,|^p|v4900^p,'^s',v7009,if p(v7063) then '^c',replace(v7063,' ','^v') fi fi</pft></call>
</function>

<!-- ============================================================================ -->
<!--  function CreateIssuesNavButtonsForJournal                                         -->
<!--                                                                              -->
<!--  Prints the current and previous issues' control information.              -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issn) of the serial.                                            -->
<!-- ============================================================================ -->
<function name="CreateIssuesNavButtonsForJournal" action="replace" tag="4900">
	<field action="delete" tag="list">7050,7085,7090,7095</field>
	<call name="GetLastRegularIssue"><pft>v4900</pft></call>
	<call name="GetPreviousIssue"><pft>v7090|^tLAST|</pft></call>
	<call name="GetNextIssue"><pft>v7090|^tLAST|</pft></call>

	<display>
		<pft>
			'  <ISSUES>',/
            
			if p(v7085) then
				'   <PREVIOUS PID="',v7085,'"',
				ref( ['NEWISSUE'] l(['NEWISSUE'], 'Y',v7085), 
					| VOL="|v31|"|,
					if p(v32) then ' NUM="',s(mpu,v32,mpl),'"' fi,
/*					| NUM="|v32|"|,   */
					| SUPPL="|v131|"|, | SUPPL="|v132|"|
				   )
				' />'/,
			fi,
			
			if p(v7090) then
				'   <CURRENT PID="',v7090^*,'"',
				ref( ['NEWISSUE'] l(['NEWISSUE'], 'Y',v7090^*), 
					| VOL="|v31|"|,
					if p(v32) then ' NUM="',s(mpu,v32,mpl),'"' fi,					
/*					| NUM="|v32|"|,	*/
					| SUPPL="|v131|"|, | SUPPL="|v132|"|
			   	   )
				' />'/,
			fi,			
			if p(v7095) then
				'   <NEXT PID="',v7095,'"',
				ref( ['NEWISSUE'] l(['NEWISSUE'], 'Y',v7095), 
					| VOL="|v31|"|,
					if p(v32) then ' NUM="',s(mpu,v32,mpl),'"' fi,					
/*					| NUM="|v32|"|,	*/
					| SUPPL="|v131|"|, | SUPPL="|v132|"|
			   	   )
				' />'/,
			fi,	
			'  </ISSUES>',/			
		</pft>
	</display>
</function>

<!-- ============================================================================ -->
<!--  function CreatePreviousNextIssue                                            -->
<!--                                                                              -->
<!--  Prints the next and previous issues' control information.                   -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issnyyyynnnn) of the current issue.                             -->
<!-- ============================================================================ -->
<function name="CreatePreviousNextIssue" action="replace" tag="4900">
	<field action="delete" tag="list">7085,7090,7095</field>
	<field action="import" tag="list">7049/7061,3900</field>

	<!--call name="GetNotPrintedIssues"><pft>mid(v4900,1,9)</pft></call-->

	<!-- inicio - get v7085 = Previous issue -->
	<call name="GetPreviousIssue"><pft>v4900</pft></call>
	<!-- fim - get v7085 = Previous issue -->

	<!-- inicio - get v7095 = Next issue -->
	<call name="GetNextIssue"><pft>v4900</pft></call>
	<!-- fim - get v7095 = Next issue -->

	<display>
		<pft>
			'  <ISSUES>',/
			if p(v7085) then
				'   <PREVIOUS PID="',v7085,'"',
				ref( ['NEWISSUE'] l(['NEWISSUE'], 'Y',v7085), 
					| VOL="|v31|"|,
/*					| NUM="|v32|"|,	*/
					if p(v32) then ' NUM="',s(mpu,v32,mpl),'"' fi,					
					| SUPPL="|v131|"|, | SUPPL="|v132|"|
				   )
				' />'/,
			fi,
			
			if p(v7095) then
				'   <NEXT PID="',v7095,'"',
				ref( ['NEWISSUE'] l(['NEWISSUE'], 'Y',v7095), 
					| VOL="|v31|"|,
/*					| NUM="|v32|"|,	*/
					if p(v32) then ' NUM="',s(mpu,v32,mpl),'"' fi,
					| SUPPL="|v131|"|, | SUPPL="|v132|"|
			   	   )
				' />'/,
			fi,
			'  </ISSUES>',/			
		</pft>
	</display>
</function>

<!-- ============================================================================ -->
<!--  function GetCurrentYear                                                       -->
<!--                                                                              -->
<!--  Gets the pid (issnyyyynnnn) of the last issue of a serial.                  -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issn) of the serial.                                            -->
<!--                                                                              -->
<!--  Return value:                                                               -->
<!--     If found, returns the pid of the last issue of the serial in the tag     -->
<!--  7090. Otherwise, returns nothing.                                           -->
<!-- ============================================================================ -->
<function name="GetCurrentYEAR" action="replace" tag="4900">
	<!--display><pft>'v4900 = ',v4900,'<br>'</pft></display-->

	<field action="import" tag="3900">3900</field>
	<field action="replace" tag="4900"><pft>v4900*0.13</pft></field>
	
	<field action="replace" tag="9000"><pft>(v3900,' ')</pft></field>
	
	<do task="keyrange">
		<!--parm name="db">NEWISSUE</parm-->
		<parm name="db">ARTIGO</parm>
		<parm name="from"><pft>'Y',v4900,'zzzz'</pft></parm>
		<!--parm name="count">1</parm-->
		<parm name="reverse">On</parm>
		
		<field action="define" tag="4901">Isis_Key</field>
		
		<loop>
			<field action="import" tag="list">4900,9000</field>
			<flow action="skip">
				<pft>
					if instr(v4901,v4900) = 0 then
						'Quit'
					else
						if l(['NEWISSUE'],v4901) > 0 then
							,if instr(v9000,v4901*1)=0 then
								'Quit' 
							,fi
						fi
					fi
				</pft>
			</flow>			
		</loop>
		<field action="export" tag="list">9000</field>
	</do>
	
	<field action="replace" tag="7090">
		<pft>
			/* If the pid of the serial (issn) isn't in the key, then it's another serial */
			if p(v4901) and instr(v4901, v4900) > 0 and instr(v9000,v4901*1)=0 then v4901*1.13 fi
		</pft>
	</field>
	<display><pft>'<!-- retorno=',v7090,' -->'</pft></display>
	
	<return action="replace" tag="7090">
		<pft>
			v7090
		</pft>
	</return>

</function>

<!-- ============================================================================ -->
<!--  function GetPreviousYEAR                                                   -->
<!--                                                                              -->
<!--  Gets the pid (issnyyyynnnn) of the previous issue of the current issue.     -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issnyyyynnnn) of the current issue.                             -->
<!--                                                                              -->
<!--  Return value:                                                               -->
<!--     If found, returns the pid of the previous issue in the tag 7085.         -->
<!--  Otherwise, returns nothing.                                                 -->
<!--  Note:                                                                       -->
<!--  If it is a ahead of print issue, the previous issue is the current issue    -->
<!--  Otherwise any previous issue but any ahead of print                         -->
<!-- ============================================================================ -->
<function name="GetPreviousYEAR" action="replace" tag="4900">
	<!--display><pft>'v4900 = ',v4900,'<br>'</pft></display-->
	<field action="import" tag="3900">3900</field>
	
	<field action="replace" tag="4900"><pft>v4900*0.13</pft></field>
	<field action="replace" tag="1001"><pft>(if instr(v3900,v4900[1])>0 then v3900 fi)</pft></field>

	<do task="keyrange">
		<!--parm name="db">NEWISSUE</parm-->
		<parm name="db">ARTIGO</parm>
		<parm name="from"><pft>'Y',v4900,'0000'</pft></parm>
		<!--parm name="count">10</parm-->
		<parm name="reverse">On</parm>
		
		<field action="define" tag="4901">Isis_Key</field>
		
		<loop>
			<display><pft>'<!-- ',v4901,' -->'/</pft></display>
			<field action="import" tag="list">4900,1001</field>
			<field action="replace" tag="4902">
				<pft>
					/* The first key found whose pid isn't the current issue's and it is not ahead neither review */
					if p(v4901) then
						if  instr(v4901,v4900) = 0 then
							/* eh a proxima chave, agora verifica se eh a mesma revista */
							if  instr(v4901,s('Y',mid(v4900,1,9))) = 1 then
								/* eh da mesma revista, mesmo issn */
								if instr(v1001,v4901*1)=0 then
									/* eh printed issue */

									if l(['NEWISSUE'],v4901) > 0 then, 
										'OK' 
									fi
								fi
							else 
								/* nao eh da mesma revista, issn diferente */
								'Error'
							fi
						else 
							/* eh a mesma chave, entao continuar */
						fi
					else
 							'Error' 
					fi 
				</pft>
			</field>
			
			<field action="export" tag="list">4901,4902</field>
			<flow action="skip">
				<pft>
					if v4902='OK' or v4902='Error' then 
						'Quit'
					fi
				</pft>
			</flow>
		</loop>	
	</do>	
	<field action="replace" tag="7085"><pft>if v4902='OK' then v4901*1.13 fi</pft></field>
	<label>fim</label>
	<return action="replace" tag="7085"><pft>v7085</pft></return>
</function>
<!-- ============================================================================ -->
<!--  function GetNextYEAR                                                       -->
<!--                                                                              -->
<!--  Gets the pid (issnyyyynnnn) of the next issue of the current issue.         -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issnyyyynnnn) of the current issue.                             -->
<!--                                                                              -->
<!--  Return value:                                                               -->
<!--     If found, returns the pid of the next issue in the tag 7095. Otherwise   -->
<!--  returns nothing.                                                            -->
<!-- ============================================================================ -->
<function name="GetNextYEAR" action="replace" tag="4900">
	<field action="import" tag="list">7049/7061</field>
	<!--display><pft>'v4900 = ',v4900,'<br>'</pft></display-->
	<!--display><pft>ALL</pft></display-->
	<field action="import" tag="3900">3900</field>
	
	<field action="replace" tag="4900"><pft>v4900*0.13</pft></field>
	
	<field action="replace" tag="1003"><pft>(v3900,' ')</pft></field>
	<do task="keyrange">
		<!--parm name="db">NEWISSUE</parm-->
		<parm name="db">ARTIGO</parm>
		<parm name="from"><pft>'Y',v4900,'zzzz'</pft></parm>
		<!--parm name="count">10</parm-->
		
		
		<field action="define" tag="4901">Isis_Key</field>
		
		<loop>
			<display><pft>'<!-- ',v4901,' -->'/</pft></display>
			<field action="import" tag="list">4900,1003</field>
			<field action="replace" tag="4902">
				<pft>
					/* The first key found whose pid isn't the current issue's and it is not ahead neither review */
					if p(v4901) then
						if  instr(v4901,v4900) = 0 then
							/* eh a proxima chave, agora verifica se eh a mesma revista */
							if  instr(v4901,s('Y',mid(v4900,1,9))) = 1 then
								/* eh da mesma revista, mesmo issn */
								if instr(v1003,v4901*1)=0 then
									/* eh printed issue */
									if l(['NEWISSUE'],v4901) > 0 then, 
										'OK' 
									fi
								fi
							else 
								/* nao eh da mesma revista, issn diferente */
								'Error'
							fi
						else 
							/* eh a mesma chave, entao continuar */
						fi
					else
 							'Error' 
					fi 
				</pft>
			</field>
			
			<field action="export" tag="list">4901,4902</field>
			<flow action="skip">
				<pft>
					if v4902='OK' or v4902='Error' then 
						'Quit'
					fi
				</pft>
			</flow>
		</loop>	
	</do>	
	<field action="replace" tag="7095"><pft>if v4902='OK' then v4901*1.13 fi</pft></field>
	<return action="replace" tag="7095"><pft>v7095</pft></return>
		
</function>
<!-- ============================================================================ -->
<!--  function CreateCurrentPreviousYear                                         -->
<!--                                                                              -->
<!--  Prints the current and previous issues' control information.              -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issn) of the serial.                                            -->
<!-- ============================================================================ -->
<function name="CreateCurrentPreviousYear" action="replace" tag="4900">
	<field action="delete" tag="list">7050,7085,7090,7095</field>
	<field action="import" tag="list">3900</field>

	<!--display><pft>| v4900 = |v4900</pft></display-->
	<!--call name="GetNotPrintedIssues"><pft>mid(v4900,1,9)</pft></call-->
	<call name="GetCurrentYEAR"><pft>v4900</pft></call>
	<call name="GetPreviousYEAR"><pft>v7090</pft></call>
	<call name="GetNextYEAR"><pft>v7090,if a(v7090) then 'NO_CURRENT_ISSUE' fi</pft></call>

	<display>
		<pft>
			'  <ISSUES>',/			
			if p(v7085) then
				'   <PREVIOUS PID="',v7085,'" YEAR="',v7085*9.4,'" />'/,
			fi,
			
			if p(v7090) then
				'   <CURRENT PID="',v7090^*,'" YEAR="',v7090*9.4,'" />'/,
			fi,			
			if p(v7095) then
				'   <NEXT PID="',v7095,'" YEAR="',v7095*9.4,'" />'/,
			fi,	
			'  </ISSUES>',/			
		</pft>
	</display>
</function>

<!-- ============================================================================ -->
<!--  function CreatePreviousNextYear                                            -->
<!--                                                                              -->
<!--  Prints the next and previous issues' control information.                   -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The pid (issnyyyynnnn) of the current issue.                             -->
<!-- ============================================================================ -->
<function name="CreatePreviousNextYear" action="replace" tag="4900">
	<field action="delete" tag="list">7085,7090,7095</field>
	<field action="import" tag="list">7049/7061,3900</field>

	<!--call name="GetNotPrintedIssues"><pft>mid(v4900,1,9)</pft></call-->

	<!-- inicio - get v7085 = Previous issue -->
	<call name="GetPreviousYEAR"><pft>v4900</pft></call>
	<!-- fim - get v7085 = Previous issue -->

	<!-- inicio - get v7095 = Next issue -->
	<call name="GetNextYEAR"><pft>v4900</pft></call>
	<!-- fim - get v7095 = Next issue -->

	<display>
		<pft>
			'  <ISSUES>',/			
			if p(v7085) then
				'   <PREVIOUS PID="',v7085,'" YEAR="',v7085*9.4,'" />'/,
			fi,
			
			if p(v7090) then
				'   <CURRENT PID="',v7090^*,'" YEAR="',v7090*9.4,'" />'/,
			fi,			
			if p(v7095) then
				'   <NEXT PID="',v7095,'" YEAR="',v7095*9.4,'" />'/,
			fi,	
			'  </ISSUES>',/			
		</pft>
	</display>
</function>

<!-- ============================================================================ -->
<!--  function CreatePreviousNextArticle                                          -->
<!--                                                                              -->
<!--  Prints the next and previous issues' control information.                   -->
<!--                                                                              -->
<!--  Arguments:                                                                  -->
<!--     The pid (issnyyyynnnn) of the current issue (v4900^p).                   -->
<!--     The interface language (v4900^l).                                        -->
<!--     The international language (v4900^i).                                    -->
<!--     Target                                                                   -->
<!--         ABS navigation based in abstract                                     -->
<!--         ART navigation based in full-text                                    -->
<!-- ============================================================================ -->
<function name="CreatePreviousNextArticle" action="replace" tag="4900">
	<field action="delete" tag="list">7085,7090,7095</field>
	<field action="import" tag="list">3900</field>

	<!--display><pft>| v4900 = |v4900</pft></display-->
	<field action="replace" tag="3000"><pft>v4900^l</pft></field>
	<field action="replace" tag="3003"><pft>v4900^i</pft></field>
	
	<!--call name="GetNotPrintedIssues"><pft>mid(v4900^p,2,9)</pft></call-->
	<field action="replace" tag="5000"><pft>(if instr(v3900,mid(v4900^p[1],2,17))>0 then v3900,'^z',f(iocc,1,0),break fi)</pft></field>

	<field action="replace" tag="5001">
		<pft>
			if p(v5000) then 
				,if val(v5000^z)>1 then 
					(if iocc=val(v5000^z[1])-1 and v3900^t=v5000^t[1] then
						,'^aS',v3900^*,
					fi)
				,fi
				,if val(v5000^z) < nocc(v3900) then 
					(if iocc=val(v5000^z[1])+1 and v3900^t=v5000^t[1] then
						,'^bS',v3900^*,
					fi)
				,fi
			,fi,
		</pft>
	</field>

	<call name="GetPreviousArticle"><pft>v4900^p,|^x|v5001^a</pft></call>
	<call name="GetNextArticle"><pft>v4900^p,|^x|v5001^b</pft></call>

	<!--display>
		<pft>
		/*
		   If navigation is based in abstract and there is no abstract
		   for the previous article, then the previous abstract does not 
		   exist. So, delete tag 7085.
		*/			
		if s(mpu,v4900^t,mpl) = 'ABS' then
			if l(['ARTIGO'],'HR=',v7085) = 0 then
				'DELETE v7085 by LOOKUP'
			else
				ref (['ARTIGO']l(['ARTIGO'],'HR=',v7085), 
					if a(v83) then 'DELETE v7085' fi)
			fi
		fi
		</pft>
	</display-->

	<field action="delete" tag="7085">
		<pft>
		/*
		   If navigation is based in abstract and there is no abstract
		   for the previous article, then the previous abstract does 
		   not exist. So, delete tag 7085.
		*/			
		if s(mpu,v4900^t,mpl) = 'ABS' then
			if l(['ARTIGO'],'HR=',v7085) = 0 then
				'DELETE v7085 by LOOKUP'
			else
				ref (['ARTIGO']l(['ARTIGO'],'HR=',v7085), 
					@PROC_SPLIT_MST.PFT,if a(v83) then 'DELETE v7085' fi)
			fi
		fi
		</pft>
	</field>
	
	<!--display>
		<pft>
	    /*
		   If navigation is based in abstract and there is no abstract
		   for the next article, then the next abstract does not exist.
		   So, delete tag 7095.
		*/
		if s(mpu,v4900^t,mpl) = 'ABS' then
			if l(['ARTIGO'],'HR=',v7095) = 0 then
				'DELETE v7095 by LOOKUP'
			else
				ref (['ARTIGO']l(['ARTIGO'],'HR=',v7095), 
					if a(v83) then 'DELETE v7095' fi)
			fi
		fi
		</pft>
	</display-->
	
	<field action="delete" tag="7095">
		<pft>
	    /*
		   If navigation is based in abstract and there is no abstract
		   for the next article, then the next abstract does not exist.
		   So, delete tag 7095.
		*/
		if s(mpu,v4900^t,mpl) = 'ABS' then
			if l(['ARTIGO'],'HR=',v7095) = 0 then
				'DELETE v7095 by LOOKUP'
			else
				ref (['ARTIGO']l(['ARTIGO'],'HR=',v7095), 
					@PROC_SPLIT_MST.PFT,if a(v83) then 'DELETE v7095' fi)
			fi
		fi
		</pft>
	</field>
	
	<!-- ref( ['ARTIGO'] l(['ARTIGO'], 'IV=S',v7085,'=H'), '    ',v12/) -->
	<display>
		<pft>
			'  <CURRENTISSUE PID="',mid(v4900^p, 2, size(v4900^p)-5-1),'"',
			   ref (['NEWISSUE']l(['NEWISSUE'], 'Y',mid(v4900^p, 2, size(v4900^p)-5-1)),
			     | VOL="|v31|"|,
				 if p(v32) then ' NUM="',s(mpu,v32,mpl),'"' fi,
				 | SUPPL="|v131|"|,| SUPPL="|v132|"|),
			' />'/

			'  <ARTICLES>',/		
			if p(v7085) then '   <PREVIOUS PID="', v7085, '"><![CDATA[', fi,
		</pft>
	</display>
	
	<!--call name="DisplayTextInAvailableLang">
		<pft>
    	ref (['ARTIGO']l(['ARTIGO'],'HR=',v7085),(v12/))
		</pft>
	</call-->
	
	<proc>
    	<pft>
        	'd9999',
            ref (['ARTIGO']l(['ARTIGO'],'HR=',v7085),
				@PROC_SPLIT_MST.PFT,(|<9999>|v12|</9999>|/))                         
        </pft>
	</proc>
	
	<call name="DisplayTextInAvailableLang">        
    	<pft>( replace(v9999,'"','&quot;')/ )</pft>
    </call>
	
	<display>
		<pft>		
			if p(v7085) then ']]></PREVIOUS>'/ fi,
			if p(v7095) then '   <NEXT PID="', v7095, '"><![CDATA[' fi,
		</pft>
	</display>
	
	<!--call name="DisplayTextInAvailableLang">
		<pft>
    	ref (['ARTIGO']l(['ARTIGO'],'HR=',v7095),(v12/))
		</pft>
	</call-->

	<proc>
    	<pft>
        	'd9999',
            ref (['ARTIGO']l(['ARTIGO'],'HR=',v7095),
				@PROC_SPLIT_MST.PFT,(|<9999>|v12|</9999>|/))                         
        </pft>
	</proc>

	<call name="DisplayTextInAvailableLang">        
    	<pft>( replace(v9999,'"','&quot;')/ )</pft>
    </call>
	
	<display>
		<pft>
			if p(v7095) then ']]></NEXT>'/ fi,
			'  </ARTICLES>',/
		</pft>			
	</display>
</function>

<!--function name="CreatePDFLinkXML" action="replace" tag="4900">
	<display><pft>'  <PDF>'/,'   '</pft></display>
	<call name="PrintPDFLink"><pft>v4900</pft></call>
	<display><pft>/,'  </PDF>'/</pft></display>	
</function-->

<function name="CreatePDFLinkXML" action="replace" tag="4900">
	<display><pft>'  <PDF>',v4900,'</PDF>'</pft></display>
</function>

<function name="CreatePathControlInfoXML" action="replace" tag="4900">
	<field action="import" tag="list">7009/7061</field> <!-- fixed -->

	<display>
		<pft>
		'  <SCIELO_INFO>'/,
		'   <SERVER>',           v7009, '</SERVER>',/
		'   <PATH_WXIS>',        v7010, '</PATH_WXIS>',/
		'   <PATH_CGI-BIN>',     v7012, '</PATH_CGI-BIN>'/,
		'   <PATH_DATA>',        v7013, '</PATH_DATA>'/,
		'   <PATH_SCRIPTS>',     v7015, '</PATH_SCRIPTS>'/,
		'   <PATH_SERIAL_HTML>', v7016, '</PATH_SERIAL_HTML>'/,
		'   <PATH_XSL>',         v7017, '</PATH_XSL>'/,
		'   <PATH_GENIMG>',      v7018, '</PATH_GENIMG>'/,
		'   <PATH_SERIMG>',      v7019, '</PATH_SERIMG>'/,
		'   <PATH_DATA_IAH>',    v7020, '</PATH_DATA_IAH>'/,
		'   <PATH_CGI_IAH>',     v7021, '</PATH_CGI_IAH>'/,
                '   <PATH_HTDOCS>',      v7044, '</PATH_HTDOCS>'/,
                |   <STAT_SERVER_CITATION>|v7045|</STAT_SERVER_CITATION>|/,
                |   <STAT_SERVER_COAUTH>|v7058|</STAT_SERVER_COAUTH>|/,
		if v7035 = '1' then,
		'   <SERVER_LOG>', v7036, '</SERVER_LOG>'/,
		'   <SCRIPT_LOG_NAME>', v7037, '</SCRIPT_LOG_NAME>'/,
		'   <SERVER_LOG_PROC>', v7056, '</SERVER_LOG_PROC>'/,
		'   <SERVER_LOG_PROC_PATH>', v7057, '</SERVER_LOG_PROC_PATH>'/,
		'   <ENABLE_ARTICLE_LANG_LINK>', v7061, '</ENABLE_ARTICLE_LANG_LINK>'/,

		fi,
        '  </SCIELO_INFO>'/,
		</pft>		
	</display>
</function>

<function name="CreateTitleGroupXML" action="replace" tag=4001>
<!-- Generate XML for Title Group
     4001 - Title MFN in the TITLE DB -->
  
  <display>
   <pft>' <TITLEGROUP>'/,
        ref(['TITLE']val(v4001),
			'  <TITLE><![CDATA[',replace(v100,'"','&quot;'),']]></TITLE>'/,
			"  <SUBTITLE><![CDATA["v110"]]></SUBTITLE>"/,
			"  <SHORTTITLE><![CDATA["v150"]]></SHORTTITLE>"/,
			"  <SHORTTITLE-MEDLINE><![CDATA["v421"]]></SHORTTITLE-MEDLINE>"/,
			"  <SIGLUM>"v68"</SIGLUM>"/,
			('<SUBJECT><![CDATA[',mpu,v441,']]></SUBJECT>'/,)
			),
		' </TITLEGROUP>'/#</pft>
  </display>
  <call name="displayXMLJournalStatusHistory"><pft>ref(['TITLE']val(v4001),v400)</pft></call>
</function>

<function name="CreateChangesInfoXML" action="replace" tag=4001>
<!-- Generate XML for Changes Info
     4001 - Title MFN in the TITLE DB -->

  <field action="replace" tag="610" split="occ"><pft>ref(['TITLE']val(v4001),(v610/))</pft></field>
  <field action="replace" tag="710" split="occ"><pft>ref(['TITLE']val(v4001),(v710/))</pft></field>
	 
  <display><pft>if p(v610) or p(v710) then ' <CHANGESINFO>'/ fi</pft></display>       	  
  <call name="CreateFormerTitleXML"><pft>(v610/)</pft></call>	  
  <call name="CreateNewTitleXML"><pft>(v710/)</pft></call>	  	  
  <display><pft>if p(v610) or p(v710) then ' </CHANGESINFO>'/# fi</pft></display>
</function>


<function name="PrintTitleISSNList" action="replace" tag=4001>
	<call name="getTitleISSNList"><pft>v4001</pft></call>
	<display>
		<pft>
			'   <TITLE',| ISSN="|v400|"|,'><![CDATA[',v4001,']]></TITLE>'/
		</pft>
	</display>
</function>


<function name="getTitleISSNList" action="replace" tag=4001>
<!-- Generate Title+ISSN List -->
  
  <field action="replace" tag="4000" split="occ"><pft>(v4001/)</pft></field>
  
  <!-- Get ISSN for every title -->
  <do>
	<parm name="to"><pft>f(nocc(v4000),1,0)</pft></parm>
	<field action="define" tag=1001>Isis_Current</field>

	<loop>
	 <field action="import" tag="list">4000</field>
	 <field action="occ" tag=9000 from=4000><pft>v1001</pft></field>
	 	 
     <do task="search">
      <parm name="db">TITLE</parm>
      <parm name="expression">
	  		<pft>
				/* 
				  A expressao abaixo deveria ser apenas '"',left(v9000,30),'"' mas parece que ha um bug no search engine
				  que nao aceita expressoes com tamanho = 29. Assim, inclui-se um espaco em branco x1 para completar 30
				*/
				
				/*
				'"',left(v9000,30), if size(v9000) = 29 then x1 fi, '"'
				*/
				'"',left(v9000,29),'$"'
			</pft>
	  </parm>

      <field action="define" tag=1001>Isis_Current</field>
      <field action="define" tag=1002>Isis_Total</field>
	  <field action="define" tag=1003>Isis_Status</field>
	
      <loop>	
	   <field action="import" tag="list">9000</field>
	   <!-- Export ISSN -->
	   <flow action="jump">
	    <pft>if s(v9000)<>s(v100) then 'CONTINUE' fi</pft>
	   </flow>
	   <field action="export" tag="list">50,400</field>
	   <flow action="skip"><pft>'Quit'</pft></flow>
	   <label>CONTINUE</label>
      </loop>

<field action="export" tag="list">50,400</field>
	 </do> 
	 
	 
<field action="export" tag="list">50,400</field>
    </loop>	

<field action="export" tag="list">50,400</field>
  </do> 
 
	  <return action="replace" tag="400">
	 	<pft>
			if v50='C' then v400 fi
		</pft>
	</return>
</function>

<function name="CreateFormerTitleXML" action="replace" tag=4001>
<!-- Generate XML for Former Title (Changes Info) 
     4001 - Former Title (repetitive) -->
  
  <display><pft>'  <FORMERTITLE>'/</pft></display>
  
  <!-- Get ISSN for every former title (if there's one) -->
  <call name="PrintTitleISSNList"><pft>v4001</pft></call>
  	 
  <display><pft>'  </FORMERTITLE>'/</pft></display>
</function>

<function name="CreateNewTitleXML" action="replace" tag=4001>
<!-- Generate XML for New Title (Changes Info) 
     4001 - New Title (repetitive) -->

  <display><pft>'  <NEWTITLE>'/</pft></display>
  
  <!-- Get ISSN for every new title (if there's one) -->
  <call name="PrintTitleISSNList"><pft>v4001</pft></call>
  	 
  <display><pft>'  </NEWTITLE>'/</pft></display>
</function>

<function name="CreateISSNXML" action="replace" tag=4001>
<!-- Generate XML for ISSN
     4001 - Title MFN in the TITLE DB -->

  <display>
   <pft>ref(['TITLE']val(v4001),' <ISSN>'v400'</ISSN>'/#)</pft>
  </display>
</function>
<function name="CreateISSN4IDXML" action="replace" tag=4001>
<!-- Generate XML for ISSN
     4001 - Title MFN in the TITLE DB -->

  <display>
   <pft>ref(['TITLE']val(v4001),' <ISSN_AS_ID>'v400'</ISSN_AS_ID>'/#)</pft>
  </display>
<display>
   <pft>ref(['TITLE']val(v4001),' <ISSN>'v400'</ISSN>'/#)</pft>
  </display>
</function>
<function name="CreateISSN4TITLEXML" action="replace" tag=4001>
<!-- Generate XML for ISSN
     4001 - Title MFN in the TITLE DB -->

  <display>
   <pft>
   ref(['TITLE']val(v4001),
   ,if p(v435) then
   		,(' <TITLE_ISSN',| TYPE="|v435^t|"|,'>',v435^*,'</TITLE_ISSN>')
   ,else
   ' <TITLE_ISSN',| TYPE="|v35|"|,'>',if p(v935) then v935 else v400 fi,'</TITLE_ISSN>'/
   ,fi
   ,#)</pft>
  </display>
</function>
<function name="CreateISSN4ISSUEXML" action="replace" tag=4001>
        <!-- Generate XML for ISSN
     4001 - Issue MFN in the Issue DB -->
        <field action="replace" tag="435" split="occ"><pft>ref(['NEWISSUE']val(v4001^i),(v435/),if a(v435) then v935 fi)</pft></field>

        <field action="replace" tag="1435" split="occ"><pft>if a(v435^t) then ref(['TITLE']val(v4001^*),(v435/),if a(v435) then if p(v935) then v935,'^t',v35/ else v400,'^t',v35/ fi fi)  fi</pft></field>

        <field action="replace" tag="435" split="occ"><pft>if p(v435) and a(v435^t) then (if v435[1]=v1435^* then v1435 fi) fi</pft></field>
        <field action="replace" tag="435" split="occ"><pft>if a(v435) or a(v435^t) then (v1435/) fi</pft></field>

        <display>
                <pft>(' <ISSUE_ISSN',| TYPE="|v435^t|"|,'>'v435^*'</ISSUE_ISSN>'/)</pft>
        </display>
</function>
<function name="CreateCopyrightXML" action="replace" tag=4001>
<!-- Generate XML for Copyright
	 4001 - Title MFN in the TITLE DB -->
	<field action="import" tag="list">1,7051,7000/7022</field>
	<field action="replace" tag="3000"><pft>
		if v7051='site' then
			'site'
		else
			if v7051='embargo' then

			else 
				'journal' 
			fi 
		fi</pft></field>
	<call name="showText"><pft>if a(v3000) then ref(['ARTIGO']l(['ARTIGO']v1),v264) fi</pft></call>
	<field action="replace" tag="3000"><pft>
	if p(v8264) then
		if v8264='no' then
			,'journal',
		else
			,'site',
		fi 
	fi</pft></field>
  <display>
   <pft>if v3000='journal' then  ref(['TITLE']val(v4001),' <COPYRIGHT YEAR="'mid(date,1,4)'"><![CDATA['v62']]></COPYRIGHT>'/#) fi</pft>
  </display>
  <call name="CreateScieloCopyInfoXML"><pft>if v3000='site' then 'Now' fi</pft></call>

</function>

<function name="CreateContactXML" action="replace" tag=4001>
<!-- Generate XML for Contact
	 4001 - Title MFN in the TITLE DB -->
 
  <field action="replace" tag="63" split="occ"><pft>ref(['TITLE']val(v4001),(v63/))</pft></field>
  <field action="replace" tag="64" split="occ"><pft>ref(['TITLE']val(v4001),(v64/))</pft></field>
  
  <display><pft>if p(v63) or p(v64) then ' <CONTACT>'/ fi</pft></display>	  	  
  <call name="CreateContactLinesXML"><pft>(v63/)</pft></call>
  <call name="CreateContactEmailsXML"><pft>(v64/)</pft></call>
  <display><pft>if p(v63) or p(v64) then ' </CONTACT>'/# fi</pft></display>	    
</function>

<function name="CreateContactLinesXML" action="replace" tag=4001>
<!-- Generate XML for Contact Lines
	 4001 - contact lines -->

  <field action="replace" tag="4000" split="occ"><pft>(v4001/)</pft></field>
  
  <display><pft>'  <LINES>'/,(|   <LINE><![CDATA[|v4000|]]></LINE>|/),'  </LINES>'/</pft></display>  
</function>

<function name="CreateContactEmailsXML" action="replace" tag=4001>
<!-- Generate XML for Contact Emails
	 4001 - contact emails -->

  <field action="replace" tag="4000" split="occ"><pft>(v4001/)</pft></field>
 
  <display><pft>'  <EMAILS>'/,(|   <EMAIL>|v4000|</EMAIL>|/),'  </EMAILS>'/</pft></display> 	 
</function>


<function name="CreatePublishersGroupXML" action="replace" tag="4001">
<!-- Generate XML for Publishers Group
	 4001 - Publishers -->
   <field action="replace" tag="480" split="occ"><pft>(v4001/)</pft></field>
	
	<display>
		<pft>
			' <PUBLISHERS>'/,
			(if p(v480) then 
				'  <PUBLISHER>'/
				'   <NAME><![CDATA['v480']]></NAME>'/
				'  </PUBLISHER>'/
			 fi),
			' </PUBLISHERS>'/#
		</pft>
	</display>	
</function>

<function name="CreateMissionXML" action="replace" tag="4001">
<!-- Generate XML for mission, according to interface language or international language
	4001 - mission lines -->
	<field action="import" tag="list">3000,3003</field>
	<field action="replace" tag="901" split="occ"><pft>(v4001/)</pft></field>	
	
	<call name="GetLanguage"><pft>v3000/v3003/(v901/)</pft></call>
	
	<field action="replace" tag="9000">
		<pft>(if s(mpu,v901^l)=s(mpu,v4010[1]) then mpl,v901^*,break fi)</pft>
	</field>
	
	<display><pft>' <MISSION><![CDATA['v9000']]></MISSION>'/#</pft></display>
	
</function>

<function name="CreateArticleTitleXML" action="replace" tag="4001">
<!-- Generate XML for article's title, according to selected language or interface language or international language
	4001 - article's title lines 		
	-->
	<!-- imports 3012 which contains the selected language -->
	<field action="import" tag="list">3000,3003,3012,8000,9912</field>
	<field action="replace" tag="12" split="occ"><pft>(v4001/)</pft></field>

	<!-- check if some of the data v12 is in the language v3012 -->
	<field action="replace" tag="4010">
 	    <pft>,if p(v3012) then 
				,if  s(mpu,v12):s(mpu,'^l'v3012) then v3012
				,fi
			,fi
		</pft>
	</field>

	<!-- check other languages -->
	<call name="GetLanguage"><pft>if a(v4010) then v3000/v3003/(|^l|v12^l/) fi</pft></call>

	<field action="replace"	tag="9000">
		<pft>(if s(mpu,v12^l)=s(mpu,v4010[1]) then mpl,v12^*,break fi)</pft>
	</field>
	<field action="replace"	tag="9001">
		<pft>(if s(mpu,v12^l)=s(mpu,v4010[1]) then mpl,v12^s,break fi)</pft>
	</field>
	<field action="replace"	tag="1000">
		<!--pft>if v8000='BODY' then '^i<![CDATA[^f]]>' fi</pft-->
		<pft>'^i<![CDATA[^f]]>'</pft>
	</field>


	<display>
		<pft>
			'  <TITLE>',v1000^i,v9000,v1000^f,'</TITLE>'/#
			'  <SUBTITLE>',v1000^i,v9001,v1000^f,'</SUBTITLE>'/#
		</pft>
	</display>
	<display><pft>if v8000='XML' then ,proc('a7777{',v12^l[1],'{'), (if v7777[1]<>v12^l then ,'  <trans-title xml:lang="',v12^l,'"><![CDATA['v12^*']]></trans-title>'/ fi) fi</pft></display>
	
</function>

<function name="CreateArticleAbstractXML" action="replace" split="occ" tag="4001">
<!-- Generate XML for abstract, according to interface language or international language
	4001 - abstract lines -->

	<!--
		v3000: interface language
    	v3003: default language
    	v3012: (original or translation) text language
    	v8000: XML ou ausente
    	v4001: conteudo de abstracts
    -->
	<field action="import" tag="list">3000,3003,3012,8000</field>

	<call name="GetLanguage"><pft>v3012/v3003/(|^l|v4001^l/)</pft></call>

	<!-- anteriormente tag="9000", foi substitu?o por tag="4001", reaproveitando-o, 
	pois havia um problema de mem?ia no wxis.exe, reaproveitando o campo, reaproveita-se a mem?ia -->
    <field action="replace" tag="4001">
   		<pft>(if s(mpu,v4001^l)=s(mpu,v4010[1]) then mpl,v4001^a,break fi)</pft>
    </field>

	<field action="replace"	tag="1000">
		<pft>if v8000='BODY' or a(v8000) then '^i<![CDATA[^f]]>' fi</pft>
	</field>
	
	<display>
		<pft>
			'  <ABSTRACT xml:lang="',v4010,'">',v1000^i,v4001,v1000^f,'</ABSTRACT>'/#
		</pft>
	</display>

</function>

<function name="DisplayTextInAvailableLang" action="replace" tag="4001">
	<field action="import" tag="list">3000,3003</field>
	<field action="replace" tag="9001" split="occ"><pft>(v4001/)</pft></field>	
	<field action="delete" tag="9000">All</field>

	<call name="GetLanguage"><pft>v3000/v3003/(v9001/)</pft></call>
	
	<field action="replace" tag="9000">
		<pft>
			(if s(mpu,v9001^l) = s(mpu,v4010[1]) then mpl,v9001^*,break fi)
		</pft>
	</field>
	
	<display><pft>v9000</pft></display>
</function>

<function name="CreateAuthorsGroupXML" action="replace" tag="4001">
<!-- Generate XML for Authors Group
	 4001 - pid 
     4001^n - Don't print uppercase names
     -->
	<field action="replace" tag="4001"><pft>mpu,v4001,mpl</pft></field>

	<field action="replace" tag="10" split="occ"><pft>ref(['ARTIGO']l(['ARTIGO'],'HR=',v4001^*),@PROC_SPLIT_MST.PFT,(v10/))</pft></field>
    <field action="replace" tag="11" split="occ"><pft>ref(['ARTIGO']l(['ARTIGO'],'HR=',v4001^*),@PROC_SPLIT_MST.PFT,(v11/))</pft></field>
	
	<display><pft>if p(v10) or p(v11) then ' <AUTHORS>'/ fi</pft></display>
	
    <!-- Defines tag 19988 to prevent CreateArticleAuthorsXML and CreateCorporativeAuthorsXML functions of printing uppercase names -->
    <field action="replace" tag="19988"><pft>if p(v4001^n) then v4001^n fi</pft></field>
    
	<!-- fixed_20051026 tradutor -->
	<call name="CreateArticleAuthorsXML"><pft>(if v10^r='ND' or v10^r='author' then replace(v10,'author','ND')/ fi)</pft></call>
	<call name="CreateArticleAuthorsXML"><pft>(if v10^r='TR' then v10/ fi)</pft></call>
	<call name="CreateArticleAuthorsXML"><pft>(if v10^r='ED' then v10/ fi)</pft></call>
	<call name="CreateArticleAuthorsXML"><pft>(if v10^r='COORD' then v10/ fi)</pft></call>
	<call name="CreateArticleAuthorsXML"><pft>(if v10^r='ORG' then v10/ fi)</pft></call>

	<call name="CreateCorporativeAuthorsXML"><pft>(v11/)</pft></call>

	<display><pft>if p(v10) or p(v11) then ' </AUTHORS>'/# fi</pft></display>	
	
	<field action="replace" tag="70" split="occ"><pft>replace(replace(replace(ref(['ARTIGO']l(['ARTIGO'],'HR=',v4001^*),@PROC_SPLIT_MST.PFT,(v70/)),'"',' '),'>','&gt;'),'<','&lt;'),</pft></field>
    <display><pft>if p(v70) then ('<AFF id="',v70^i,'">',
    	,if size(v70^*)>0 then
    		,'<ORGNAME><![CDATA[',v70^*,']]></ORGNAME>',#
    	,fi
    	,if size(v70^d)>0 then
    		,'<ORGDIV><![CDATA[',v70^d,']]></ORGDIV>',#
    	,fi
    	,if size(v70^1)>0 then
    		,'<ORGDIV><![CDATA[',v70^1,|, |v70^2,|, |v70^3,']]></ORGDIV>',#
    	,fi
    	,if size(v70^c)>0 then
    		,'<CITY><![CDATA[',v70^c,']]></CITY>',#
    	,fi
    	,if size(v70^p)>0 then
    		,'<COUNTRY><![CDATA[',v70^p,']]></COUNTRY>',#
    	,fi
    	
    , '</AFF>' ) fi</pft></display>
</function>

<function name="CreateAuthorsAffXML" action="replace" tag="4001">
	<!-- Generate XML for Authors affiliations
	 4001 - pid 
     
     -->
	<field action="replace" tag="4001"><pft>mpu,v4001,mpl</pft></field>

	<field action="replace" tag="70" split="occ"><pft>ref(['ARTIGO']l(['ARTIGO'],'HR=',v4001^*),@PROC_SPLIT_MST.PFT,(v70/))</pft></field>
	<flow action="jump"><pft>if a(v70) then 'exit' fi</pft></flow>

	<display><pft>'<AFFILIATIONS>'/</pft></display>	
	<display>
		<pft>
			('<AFFILIATION ID="',v70^i,'">'/,
				if v70*0.1<>'^' then 
					'<ORGNAME><![CDATA['v70^*']]></ORGNAME>'/
					'<ORGDIV><![CDATA['v70^1']]></ORGDIV>'/
					'<ORGDIV><![CDATA['v70^2']]></ORGDIV>'/
				else 
					'<ORGNAME><![CDATA['v70^1']]></ORGNAME>'/
					'<ORGDIV><![CDATA['v70^2']]></ORGDIV>'/
					'<ORGDIV><![CDATA['v70^3']]></ORGDIV>'/
				fi,
				,'<E-MAIL><![CDATA['v70^e']]></E-MAIL>'/
			,'<CITY><![CDATA['v70^c']]></CITY>'/
			,'<STATE><![CDATA['v70^s']]></STATE>'/
			,'<COUNTRY><![CDATA['v70^p']]></COUNTRY>'/
			,'</AFFILIATION>'/)
		</pft>
	</display>	

	<display><pft>'</AFFILIATIONS>'/</pft></display>	

	<label>exit</label>
</function>

<function name="CreateArticleAuthorsXML" action="replace" tag="4001">
<!-- Generate XML for Analitic Authors Group
	 4001 - Analitic Authors 
     19988 - Flag. It will be imported from caller. If it is defined, the function will not print uppercase names.
-->
   
   <field action="replace" tag="10" split="occ"><pft>(v4001/)</pft></field>
   <field action="import" tag="list">19988</field>
   
	<!--proc>
		<pft>
        	'd9999',
			(|<9999>|v10|</9999>|/)
		</pft>
	</proc>

	<display>
		<pft>
			'  <AUTH_PERS>'/,
			(if p(v10^s) or p(v10^n) then
			    '   <AUTHOR SEARCH="', mpu,replace(s(v9999^s,|,+|v9999^n),' ','+'),mpl,'">'/
			    |    <NAME><![CDATA[|v10^n|]]></NAME>|,/
			    |    <SURNAME><![CDATA[|v10^s|]]></SURNAME>|/
                if p(v10^n) then
                    '    <UPP_NAME><![CDATA[', s(mpu,v10^n,mpl), ']]></UPP_NAME>',/
                fi
                if p(v10^s) then
                    '    <UPP_SURNAME><![CDATA[', s(mpu,v10^s,mpl), ']]></UPP_SURNAME>',/
                fi
				'   </AUTHOR>'/
			fi),				
			'  </AUTH_PERS>'/,
		</pft>
	</display>	
--> 
    
	<!-- fixed_20051121 tradutor -->
    <field action="replace" tag="1111">
		<pft>(if iocc=1 then 
			'^a',
			if v10^r='ND' then 
				'AUTH_PERS' 
			else 
				'PEOPLE'
		fi,
			,'^b',
			,if v10^r='ND' then 
				'AUTHOR' 
			else 
				'PERSON'
			fi,
			,if v10^r<>'ND' then 
				'^c type="',v10^r,'"' 
			fi, 
			,fi),
		</pft>
	</field>
	<!-- fixed_20051121 tradutor -->

    <display><pft>'  <',v1111^a,v1111^c,'>'/</pft></display>    
    <do>
        <parm name="count"><pft>f(nocc(v10),1,0)</pft></parm>
        
        <field action="define" tag="9876">Isis_Current</field>
        
        <field action="statusfile" tag="9901">ANSIUC.TAB</field>
        <field action="statusfile" tag="9902">ANSIUC2.TAB</field>
        
        <loop>
            <field action="import" tag="list">10,1111,9901,9902,19988</field>
            
            <field action="occ" tag="9810" from="10"><pft>v9876</pft></field>
            <field action="replace" tag="1300" split="occ"><pft>replace(v9810^1,' ',s(#))</pft></field>
           
		   
        	<proc>
        		<pft>
                	'd9999',
        			|<9999>|v9810|</9999>|/
        		</pft>
        	</proc>
			
            <flow action="jump">
                <pft>
                    if v9901^s : 'e' and v9902^s : 'e' then '' else 'NOUC1' fi
                </pft>
            </flow>
            
            <parm name="uctab"><pft>cat('ANSIUC.TAB')</pft></parm>
            
            <label>NOUC1</label>
            
            <field action="replace" tag="9999" split="occ"><pft>mpu,replace(s(v9999^s,|,+|v9999^n),' ','+'),mpl</pft></field>
            <field action="replace" tag="9999" split="occ"><pft>replace(v9999,'"','&quot;')</pft></field>
            <display>
                <pft>
                    if p(v9810^s) or p(v9810^n) then
			        '   <',v1111^b,v1111^c,' SEARCH="',v9999,'">'/
					if p(v1300) then
						('<AFF xref="',v1300,'"/>'/)
					fi
      			    |    <NAME><![CDATA[|v9810^n|]]></NAME>|,/
		    	    |    <SURNAME><![CDATA[|v9810^s|]]></SURNAME>|/                    
                    fi 
                </pft>
            </display>
            
            <flow action="jump">
                <pft>
                    if v9901^s : 'e' and v9902^s : 'e' then '' else 'NOUC2' fi
                </pft>
            </flow>
            
            <parm name="uctab"><pft>cat('ANSIUC2.TAB')</pft></parm>

            <label>NOUC2</label>
            
            <flow action="jump"><pft>if p(v19988) then 'NOUPPER' fi</pft></flow>

            <display>
                <pft>
                    if p(v9810^s) or p(v9810^n) then
                        if p(v9810^n) then
                        '    <UPP_NAME><![CDATA[', s(mpu,v9810^n,mpl), ']]></UPP_NAME>',/
                        fi
                        if p(v9810^s) then
                        '    <UPP_SURNAME><![CDATA[', s(mpu,v9810^s,mpl), ']]></UPP_SURNAME>',/
                        fi
                    fi                    
                </pft>
            </display>
            
            <label>NOUPPER</label>
            <display><pft>'   </',v1111^b,'>'/</pft></display>
        </loop>        
    </do>   

    <flow action="jump">
        <pft>
            if v9901^s : 'e' and v9902^s : 'e' then '' else 'NOUC3' fi
        </pft>
    </flow>
    
    <parm name="uctab"><pft>cat('ANSIUC.TAB')</pft></parm>        
    
    <label>NOUC3</label>
    
    <display><pft>'  </',v1111^a,'>'/</pft></display>
</function>

<function name="CreateCorporativeAuthorsXML" action="replace" tag="4001">
<!-- Generate XML for Analitic Authors Group
	 4001 - Analitic Authors 
     19988 - Flag. It will be imported from caller. If it is defined, the function will not print uppercase names.
-->
   <field action="replace" tag="11" split="occ"><pft>(v4001/)</pft></field>
   <field action="import" tag="list">19988</field>

   <field action="statusfile" tag="9901">ANSIUC.TAB</field>
   <field action="statusfile" tag="9902">ANSIUC2.TAB</field>
   
   <flow action="jump">
    <pft>
        if v9901^s : 'e' and v9902^s : 'e' then '' else 'NOUC1' fi
    </pft>
   </flow>
            
   <parm name="uctab"><pft>cat('ANSIUC2.TAB')</pft></parm>
            
   <label>NOUC1</label>

	<display>
		<pft>
			'  <AUTH_CORP>'/,
			(if p(v11^*) or p(v11^d) then
			    '   <AUTHOR>'/
			    |    <ORGNAME><![CDATA[|v11^*|]]></ORGNAME>|,/
			    |    <ORGDIV><![CDATA[|v11^d|]]></ORGDIV>|/
                if a(v19988) then
                    if p(v11) then
	    		    '    <UPP_ORGNAME><![CDATA[',s(mpu,v11^*,mpl),']]></UPP_ORGNAME>',/
                    fi
                    if p(v11^d) then
			        '    <UPP_ORGDIV><![CDATA[',s(mpu,v11^d,mpl),']]></UPP_ORGDIV>',/
                    fi
                fi
				'   </AUTHOR>'/
			fi),				
			'  </AUTH_CORP>'/,
		</pft>
	</display>	

   <flow action="jump">
    <pft>
        if v9901^s : 'e' and v9902^s : 'e' then '' else 'NOUC2' fi
    </pft>
   </flow>
            
   <parm name="uctab"><pft>cat('ANSIUC.TAB')</pft></parm>
            
   <label>NOUC2</label>
    
</function>

<function name="CreateKeywordsGroupXML" action="replace" tag="4001">
<!-- Generate XML for Publishers Group
	 4001 - Publishers -->
    <field action="replace" tag="85" split="occ"><pft>(v4001/)</pft></field>
    <field action="import" tag="list">3000,3003,3012</field>
	
	<call name="GetLanguage"><pft>v3012/v3003/(|^l|v85^l/)</pft></call>
	
	<!--display><pft>'v9000=',v9000,'<br>'/</pft></display-->
	<display>
		<pft>
			' <KEYWORDS>'/,			
			(
			if s(mpu,v85^l) = s(mpu,v4010[1]) then
				mpl,
				if p(v85^k) then
				'  <KEYWORD>'/,
					'   <KEY><![CDATA[',v85^k,']]></KEY>'/,
					|   <SUBKEY><![CDATA[|v85^s|]]></SUBKEY>|/,
				'  </KEYWORD>'/,
				fi
			fi,mpl),
			' </KEYWORDS>'/#
		</pft>
	</display>	
</function>

<!--function name="TestPDFPresence" action="replace" tag="4900">
	<display><pft>ref (['PDF']l(['PDF'],v4900), ' PDF="1"')</pft></display>	
</function-->

<!--function name="PrintPDFLink" action="replace" tag="4900">
	<display><pft>ref (['PDF']l(['PDF'],v4900), v2)</pft></display>	
</function-->

<function name="getSerialPdfUrl" action="replace" tag="4910"> <!-- fixed 20040622 -->
<!-- Gets the pdf file url of an article, given the pid of this article.

    4900 - pid
	Return the url in tag 7999 if pdf file is found or
	nothing (tag 7999 undefined), otherwise.
-->
		<field action="replace" tag="4900" split="occ"><pft>v4910[1]</pft></field> <!-- fixed 20040622 -->

	 <!-- Try to get the information needed to assemble the url (host name, domain, 
	 	  path, ...) -->
  <!-- fixed 20041118 -->
	<field action="import" tag="list">4040,7009/7061</field> <!-- fixed -->

	 <!-- Try to get the information needed to assemble the url (host name, domain, 
	 	  path, ...) -->

	<!-- Get the lowercase siglum of the serial -->
	<field action="replace" tag="9000">
		<pft>
		ref(['TITLE']l(['TITLE'],'LOC=',mpu,mid(v4900,2,9),mpl),v68),			
		</pft>
	</field>
	
	<!--display><pft>' sigla: ',v9000</pft></display-->

	<!-- Gets the volumn number, issue number and supplement number -->
	<field action="replace" tag="9001">
		<pft>
			ref( ['NEWISSUE'] l( ['NEWISSUE'],'Y',mid(v4900,2,size(v4900)-5-1) ),
				,if (v32='ahead' or v32='review') and val(v65*0.4) > 2007 then ,v65*0.4, fi,
				"v"v31,"n"v32,"s"v131,"s"v132 )
		</pft>
	</field>

	<!--display><pft>' vxxnxxsxx: ',v9001</pft></display-->

	<!-- Gets the html file name. The pdf file has the same name as the html file,
 		 excluding the file extension. The only exception is the bjmbr serial.
	     In this case, the pdf file name is one character shorter.
	 -->
	<field action="replace" tag="9002">
		<pft>
    	ref(['ARTIGO']l(['ARTIGO'],'OU=',mpu,v4900,mpl),@PROC_SPLIT_MST.PFT,v799)
		</pft>
	</field>
	<!-- fixed 20040622 faltava R do HR= -->
	<field action="replace" tag="40">
		<pft>
    	ref(['ARTIGO']l(['ARTIGO'],'HR=',mpu,v4900,mpl),@PROC_SPLIT_MST.PFT,v40)
		</pft>
	</field>

	<field action="replace" tag="7900">
				<pft>if p(v7060) then
					if ref(['ARTIGO']l(['ARTIGO'],'HR=',mpu,v4900,mpl),@PROC_SPLIT_MST.PFT,v761)='1' or instr(v9002,'.pdf')>0 then
					,replace(v7060,'REPLACE_VOLUME',ref(['ARTIGO']l(['ARTIGO'],'HR=',mpu,v4900,mpl),@PROC_SPLIT_MST.PFT,v31)),'/',v9002,
					fi,
fi
				</pft>
			</field>

	<flow action="jump"><pft>if p(v7900) then 'GOTTEN_PDF' fi</pft></flow>
	<!--display><pft>' name: ',v9002</pft></display-->

	<!-- Gets the html file name. The pdf file has the same name as the html file,
 		 excluding the file extension. The only exception is the bjmbr serial.
	     In this case, the pdf file name is one character shorter.
	 -->
	 <!-- fixed 20040622 at?o final da funcao -->
	<list action="load" type="list"><pft>(v4040/)</pft></list>

	<do task="list">
	     <field action=define tag="1001">Isis_Current</field>
	     <field action=define tag="1002">Isis_Items</field>
	     <field action=define tag="1">Isis_Item</field>
	     <loop>
		 	<field action="import" tag="list">40,7009,7022,9000/9003</field>
		 	<field action="import" tag="list">7900</field>
		 	
	 
			<field action="replace" tag="9003" split="occ">
				<pft>				
					if p(v9000) and p(v9001) and p(v9002) then
						v9000,'/',v9001,'/',
						if v40<>v1 then
							v1'_',
						fi
		    			left(v9002,instr(v9002,'.')-1),
						'.pdf'
					fi
				</pft>
			</field>	
			<field action="replace" tag="9005" split="occ">
				<pft>				
					if p(v9003) then
						'^p',v7022,
						'^f',
						if instr(v7022, '\') > 0 then 
							replace(v9003,'/','\')
						else
							v9003
						fi
					fi
				</pft>
			</field>

			<call name="existeFile"><pft>v9005</pft></call>
			<field action="add" tag="7900">
				<pft>
					if v7999<>'' then 'http://',v7009,'/pdf/'v7999 fi
				</pft>
			</field>
<!--display><pft>('url='v7900/)</pft></display-->
			
			<field action="export" tag="7900">7900</field>
			<flow action="skip"><pft>if v7900<>'' then 'Quit' fi</pft></flow>

	     </loop>

	  </do>
	  <list action="delete">now</list>
<!--display><pft>('URL='v7900/)</pft></display-->

	<label>GOTTEN_PDF</label>
	<field action="export" tag="7999">7900</field>

</function>

<function name="existeFile" action="replace" tag="4900">

	<field action="statusfile" tag="9004">
		<pft>v4900^p,v4900^f</pft>
	</field>
	<field action="replace" tag="7999">
		<pft>				
			if v9004^s : 'e' then
				,v4900^f,
			fi
		</pft>
	</field>

	<field action="export" tag="list">7999</field>
</function>

<function name="TestPDFPresence" action="replace" tag="4900">
<!-- If there is a pdf then generate the attribute pdf="1"
     4900 - pid -->
	<field action="import" tag="list">40,7009/7061</field>

	<!-- Get the url of the pdf file -->
	<!-- fixed 20040622 -->
	<field action="import" tag="4040">4040</field>
	<call name="getSerialPdfUrl"><pft>v4900</pft></call>

	<flow action="jump"><pft>if p(v7999) then 'PDF_OK' fi</pft></flow>
    <call name="getAvailableTextLanguages"><pft>mid(v4900,2,9)</pft></call>
    <field action="replace" tag="4040" split="occ"><pft>v40/,(if v9350<>v40[1] then v9350 fi/)</pft></field>
	<call name="getSerialPdfUrl"><pft>v4900</pft></call>
	
	<label>PDF_OK</label>
	<display><pft>if p(v7999) then ' PDF="1"' fi</pft></display>
</function>

<!-- fixed -->
<function name="getAvailableTextLanguages" action="replace" tag="4900">
<!-- return the available languages to fulltext
     4900 - issn -->
	 <field action="replace" tag="9350" split="occ"><pft>ref(['TITLE']l(['TITLE'],'LOC=',v4900),(v350/))</pft></field>
	 <field action="export" tag="list" >9350</field>
			
</function>

<function name="TestTranslationPresence" action="replace" tag="4901" split="occ">
<!-- If there is the translations then generate the elements translation
     4901 - pid 
	 4901^o - original language	 
	 4901^l - languages
 	 4901^d - directory	 
 	 4901^e - pdf ou tr (translation)	 
 	 4901^i - colocar o pid como atributo uso em press release
	 -->
	 <!--display><pft>ALL</pft></display-->	
	<field action="import" tag="list">966,7060</field>

   <field action="replace" tag="4901" split="occ"><pft>(v4901/)</pft></field> 
   <field action="replace" tag="4902" split="occ"><pft>(v4901^l/)</pft></field> 
   <field action="replace" tag="4904" split="occ"><pft>(v4901^d/)</pft></field> 
   <field action="replace" tag="4905" split="occ"><pft>(v4901^e/)</pft></field>
   <field action="replace" tag="3232" split="occ"><pft>(v4901^i/)</pft></field>
   
   	<field action="replace" tag="9005" split="occ"><pft>if v4905[1]='' then ref(['ARTIGO']l(['ARTIGO'],'HR=',mpu,v4901^*[1],mpl),@PROC_SPLIT_MST.PFT,(if p(v601) then '<LANG>',v601,'</LANG>'/ fi)) fi</pft></field>
	<flow action="jump"><pft>if p(v9005) then 'END_FIND_TRANSLATIONS' fi</pft></flow>
    
    <!-- INICIO TRECHO QUE TRATA DE PDF EXTERNO: V7060 -->
	<field action="replace" tag="9005" split="occ">
		<pft>if p(v7060) and v4905='pdf' then
				ref(['ARTIGO']l(['ARTIGO'],'HR=',mpu,v4901^*[1],mpl),@PROC_SPLIT_MST.PFT,if v761='1' then v761 else '0' fi/,v31/)
			fi
		</pft>
	</field>
	<field action="replace" tag="9005">
		<pft>if v9005[1]='1' then
			'<LANG TRANSLATION="',replace(v7060,'REPLACE_VOLUME',v9005[2]),'/',ref(['ARTIGO']l(['ARTIGO'],'OU=',mpu,v4901^*[1],mpl),@PROC_SPLIT_MST.PFT,v799),'">',v4902,'</LANG>'/
				
			fi
		</pft>
	</field>	
	<flow action="jump"><pft>if p(v9005) then 'END_FIND_TRANSLATIONS' fi</pft></flow>
    <!-- FIM TRECHO QUE TRATA DE PDF EXTERNO -->
	


   <!-- fixed 20070119 - insero de mais idiomas no texto completo e pdf -->
   <call name="getAvailableTextLanguages"><pft>if v4905='pdf' or a(v4902) or v4902='' then mid(v4901,2,9) fi</pft></call>

   <field action="replace" tag="4902" split="occ"><pft>(v9350/)</pft></field> 	
   <field action="add" tag="4902"><pft>if v4905='pdf' then v4901^o/  fi</pft></field> 	
   <!-- fixed 20070119 -->

   <field action="replace" tag="4906" split="occ"><pft>(v4901^o/)</pft></field> <!-- fixed 20040622 -->
   <field action="replace" tag="4900"><pft>v4901[1]</pft></field>
   
   
   <flow action="jump"><pft>if v4902='' then 'END_FIND_TRANSLATIONS' fi</pft></flow>
   <flow action="jump"><pft>if p(v966) then 'DO_NOT_CHECK_FILE_SYSTEM' fi</pft></flow>
   <!-- Try to get the information needed to assemble the url (host name, domain, 
	 	  path, ...) -->
	<field action="import" tag="list">7009/7061</field>
	
	<!-- Get the lowercase siglum of the serial -->
	<field action="replace" tag="9000">
		<pft>
		ref(['TITLE']l(['TITLE'],'LOC=',mpu,mid(v4900,2,9),mpl),v68),			
		</pft>
	</field>

	<!-- Gets the volumn number, issue number and supplement number -->
	<field action="replace" tag="9001">
		<pft>
			ref( ['NEWISSUE'] l( ['NEWISSUE'],'Y',mid(v4900,2,size(v4900)-5-1) ),
,if (v32='ahead' or v32='review') and val(v65*0.4) > 2007 then ,v65*0.4, fi,
				"v"v31,"n"v32,"s"v131,"s"v132,v41  )
		</pft>
	</field>
	<field action="replace" tag="9001">
		<pft>
			if a(v9001) then ref( ['NEWISSUE'] l( ['NEWISSUE'],'P',mid(v4900,2,size(v4900)-5-1) ),
,if (v32='ahead' or v32='review') and val(v65*0.4) > 2007 then ,v65*0.4, fi,
				"v"v31,"n"v32,"s"v131,"s"v132,v41 )
				fi
		</pft>
	</field>
	<field action="replace" tag="9001">
		<pft>
			if a(v9001) then ref( ['NEWISSUE'] l( ['NEWISSUE'],'A',mid(v4900,2,size(v4900)-5-1) ),
,if (v32='ahead' or v32='review') and val(v65*0.4) > 2007 then ,v65*0.4, fi,
				"v"v31,"n"v32,"s"v131,"s"v132,v41  )
				fi
		</pft>
	</field>
	<field action="replace" tag="9001">
		<pft>
			if a(v9001) then ref( ['NEWISSUE'] l( ['NEWISSUE'],'R',mid(v4900,2,size(v4900)-5-1) ),
,if (v32='ahead' or v32='review') and val(v65*0.4) > 2007 then ,v65*0.4, fi,
				"v"v31,"n"v32,"s"v131,"s"v132,v41  )
				fi
		</pft>
	</field>
	<!--display><pft>' vxxnxxsxx: ',v9001</pft></display-->

	<!-- Gets the html file name. The traslation file has the same name as the html file, 
		 prefixed by the language + _ excluding the file extension. 
		 The only exception is the bjmbr serial.
	     In this case, the pdf file name is one character shorter.
	 -->
	<field action="replace" tag="9002"><pft>ref(['ARTIGO']l(['ARTIGO'],'OU=',mpu,v4900,mpl),@PROC_SPLIT_MST.PFT,v799)</pft></field>
	<field action="replace" tag="9002">
		<pft>
			if v4905<>'' then
	   			left(v9002,instr(v9002,'.')-1),
				'.',v4905
			else 
				v9002,
			fi
		</pft>
	</field>
	<field action="replace" tag="9002">
		<pft>
			replace(replace(v9002,'.HTML','.html'),'.HTM','.htm')
		</pft>
	</field>


	<!-- Assembles the relative path -->

	
	<!--display><pft>' relative path: ',v9003</pft></display-->
	
	
	<!-- Verify the presence of the files. The full path is compounded by the 
		base path and relative path.
	-->
	<list action="load" type="freq"><pft>(v4902/)</pft></list>
	<do task="list">
	     <field action="define" tag="4903">Isis_Current</field>
	     <field action="define" tag="4922">Isis_Item</field>>
    	
    	
		<loop>
			<field action="import" tag="list">3232,9000/9002,9005,4904/4906</field> <!-- fixed 20040622 -->
			<!--display><pft>ALL</pft></display-->
			<field action="replace" tag="9003">
				<pft>
					 if p(v9000) and p(v9001) and p(v9002) then 
					 	
							'^f',v9000,'/',v9001,'/',
							if v4922<>v4906 then
								v4922|_|,
							fi,
	    					v9002,
							'^l',v4922
					 fi 
				</pft>
			</field>
			<field action="statusfile" tag="9004">
				<pft>
					if p(v9003) then
						v4904,
						if instr(v4904, '\') > 0 then 
							replace(v9003^f,'/','\')
						else
							v9003^f
						fi
					fi
				</pft>
			</field>
			<field action="replace" tag="9005"><pft>v9005,if v9004^s : 'e' then '<LANG ',| pid="|v3232|" |,'TRANSLATION="',v9003^f,'">',v9003^l,'</LANG>'/ fi</pft></field>
			<field action="export" tag="list">9000/9002,9005,4904,4905</field>
			<!--display><pft>ALL</pft></display-->

		</loop>
	</do>
	<list action="delete">now</list>
	<flow action="jump">END_FIND_TRANSLATIONS</flow>

	<label>DO_NOT_CHECK_FILE_SYSTEM</label>
	<field action="replace" tag="4905"><pft>if v4905='' then 'tr' fi</pft></field>
	<field action="replace" tag="9005" split="occ"><pft>(if v966^t=v4905[1] then '<LANG TRANSLATION="',v966^f,'">',v966^l,'</LANG>'/ fi)</pft></field>

	<!--display><pft>'status: ',v9004</pft></display-->
	
	<!--display><pft>'http://',v7009,"."v7010,'/pdf/'v9003</pft></display-->
	<label>END_FIND_TRANSLATIONS</label>
	<field action="export" tag="7999">9005</field>
	
</function>

<!-- fixed 20040614 -- nova funcao -- texto completo / traducao -->
<function name="GetTranslationFileNames" action="replace" tag="4901">
<!-- If there is the translations then generate the elements translation
     4901^o - idioma do texto original
     4901^p - pid 
	 4901^l - language da interface
	 4901^d - diret?io da traduo (pdf ou translation)
	-->
	
	<flow action="jump"><pft>if v4901^o=v4901^l then 'end' else 'getFileNames' fi</pft></flow>
	<label>getFileNames</label>
	
	<call name="GetTranslationFileName"><pft>v4901^p/,'^l',v4901^l/,'^d',v4901^d/</pft></call>
	<field action="add" tag="8000"><pft>v7999</pft></field>
	<call name="GetTranslationFileName"><pft>v4901^p/,'^l',v4901^l/,'^d',v4901^d/,'^ab'</pft></call>
	<field action="add" tag="8000"><pft>v7999</pft></field>
	<call name="GetTranslationFileName"><pft>v4901^p/,'^l',v4901^l/,'^d',v4901^d/,'^ax'</pft></call>
	<field action="add" tag="8000"><pft>v7999|^xCLOSE_BODY|</pft></field>
	<field action="export" tag="7999">8000</field>
	
	<label>end</label>	
</function>

<function name="GetTranslationFileName" action="replace" tag="4901" split="occ">
<!-- If there is the translations then generate the elements translation
     4901 - pid 
	 4901^l - language
	 4901^a - indica se ?o arquivo do trecho do texto completo ap? as refer?cias: ausente ou caracter 'b' (back)
	 4901^d - diret?io da traduo (pdf ou translation)
	 -->
   <field action="replace" tag="4901" split="occ"><pft>(v4901/)</pft></field> 
   <field action="replace" tag="4902" split="occ"><pft>(v4901^l/)</pft></field> 
   <field action="replace" tag="4904" split="occ"><pft>(v4901^d/)</pft></field>    
   <field action="replace" tag="4905" split="occ"><pft>(v4901^a/)</pft></field>    
   <field action="replace" tag="4900"><pft>v4901[1]</pft></field>
   <!-- Try to get the information needed to assemble the url (host name, domain, 
	 	  path, ...) -->
	<field action="import" tag="list">7009/7061</field>
	
	<!-- Get the lowercase siglum of the serial -->
	<field action="replace" tag="9000">
		<pft>
		ref(['TITLE']l(['TITLE'],'LOC=',mpu,mid(v4900,2,9),mpl),v68),			
		</pft>
	</field>

	<!-- Gets the volumn number, issue number and supplement number -->
	<field action="replace" tag="9001">
		<pft>
			ref( ['NEWISSUE'] l( ['NEWISSUE'],'Y',mid(v4900,2,size(v4900)-5-1) ),
,if (v32='ahead' or v32='review') and val(v65*0.4) > 2007 then ,v65*0.4, fi,
				"v"v31,"n"v32,"s"v131,"s"v132,v41 )
		</pft>
	</field>
	<field action="replace" tag="9001">
		<pft>if a(v9001) then
			ref( ['NEWISSUE'] l( ['NEWISSUE'],'P',mid(v4900,2,size(v4900)-5-1) ),
			,if (v32='ahead' or v32='review') and val(v65*0.4) > 2007 then ,v65*0.4, fi,
				"v"v31,"n"v32,"s"v131,"s"v132,v41 )
				fi
		</pft>
	</field>

	<!--display><pft>' vxxnxxsxx: ',v9001</pft></display-->

	<!-- Gets the html file name. The traslation file has the same name as the html file, 
		 prefixed by the language + _ excluding the file extension. 
		 The only exception is the bjmbr serial.
	     In this case, the pdf file name is one character shorter.
	 -->
	<field action="replace" tag="9002">
		<pft>
    	ref(['ARTIGO']l(['ARTIGO'],'OU=',mpu,v4900,mpl),@PROC_SPLIT_MST.PFT,v799)
		</pft>
	</field>
	<field action="replace" tag="9002">
		<pft>
			replace(replace(v9002,'.HTML','.html'),'.HTM','.htm')
		</pft>
	</field>

	<!--display><pft>' name: ',v9002</pft></display-->

	<!-- Assembles the relative path -->
	<field action="replace" tag="9003">
		<pft>				
			if p(v9000) and p(v9001) and p(v9002) then
				v9000,'/',v9001,'/',
				v4902|_|,v4905
    			v9002
			fi
		</pft>
	</field>
	<!--display><pft>' relative path: ',v9003</pft></display-->
	<!-- Verify the presence of the files. The full path is compounded by the 
		base path and relative path.
	-->
	<field action="replace" tag="9005">
		<pft>
			if p(v9003) then
				v4904,
				if instr(v4904, '\') > 0 then 
					replace(v9003,'/','\')
				else
					v9003
				fi
			fi
		</pft>
	</field>
	<field action="statusfile" tag="9004">
		<pft>v9005</pft>
	</field>
	<field action="replace" tag="9006"><pft>if v9004^s : 'e' then v9005 else fi</pft></field>
	
	<!--display><pft>'status: ',v9004</pft></display-->
	
	<!--display><pft>'http://',v7009,"."v7010,'/pdf/'v9003</pft></display-->
	<field action="export" tag="7999">9006</field>	
	
</function>



<function name="CreateScieloCopyInfoXML" action="replace" tag="4900">
	<field action="import" tag="list">7000/7022</field>
	<!--display>
		<pft>
			' <COPYRIGHT YEAR="',left(date,4),'">',/
			'  <OWNER>', ref (['INSTALL']1, v9),'</OWNER>',/
			'  <CONTACT>', ref (['INSTALL']1, v10),'</CONTACT>',/
			' </COPYRIGHT>',/#
		</pft>
	</display-->
	<display>
		<pft>
			' <COPYRIGHT YEAR="',left(date,4),'">',/
			'  <OWNER>',v7001,'</OWNER>',/
			'  <OWNER-FULLNAME>',v7000,'</OWNER-FULLNAME>',/
			'  <CONTACT>',v7008,'</CONTACT>',/
			' </COPYRIGHT>',/#
		</pft>
	</display>
</function>

<function name="CreateScieloInfoXML" action="replace" tag="4900">
	<field action="import" tag="list">7000/7022</field>
	<!--display>
		<pft>
			' <SCIELOINFOGROUP>'/
			'  <ORGANIZATION>'ref (['INSTALL']1, v3)'</ORGANIZATION>'/
			'  <ADDRESS>'/,
			'   <STREETADDR>'ref (['INSTALL']1, v4)'</STREETADDR>'/
			'   <ZIPSTATE>'ref (['INSTALL']1, v5)'</ZIPSTATE>'/
			'   <COUNTRY>'ref (['INSTALL']1, v6)'</COUNTRY>'/
			'  </ADDRESS>'/,
			'  <PHONE>'ref (['INSTALL']1, v7)'</PHONE>'/
			'  <FAX>'ref (['INSTALL']1, v8)'</FAX>'/
			'  <EMAIL>'ref (['INSTALL']1, v10)'</EMAIL>'/
			' </SCIELOINFOGROUP>'/#
		</pft>
	</display-->
	<display>
		<pft>
			' <SCIELOINFOGROUP>'/
			'  <SITE_NAME>',v7000,'</SITE_NAME>'/
			'  <ORGANIZATION>',v7002,'</ORGANIZATION>'/
			'  <ADDRESS>'/,
			'   <ADDRESS_1>',v7003,'</ADDRESS_1>'/
			'   <ADDRESS_2>',v7004,'</ADDRESS_2>'/
			'   <COUNTRY>',v7005,'</COUNTRY>'/
			'  </ADDRESS>'/,
			'  <PHONE>',v7006,'</PHONE>'/
			'  <FAX>',v7007,'</FAX>'/
			'  <EMAIL>',v7008,'</EMAIL>'/
			' </SCIELOINFOGROUP>'/#
		</pft>
	</display>
</function>

<function name="CreateArticleTitle1XML" action="replace" tag=4001>
<!-- Generate XML for Title of Article
     ^r - MFN 
	 ^l - Interface Language 
	 ^i - International Language 
	 ^f - Flag: 0 - preserve Html tags in title (absent - default: preserve)
	            1 - remove Html tags from title
-->
  	 
  <field action="replace" tag="3000"><pft>v4001^l</pft></field>
  <field action="replace" tag="3003"><pft>v4001^i</pft></field>
  
  <field action="import" tag="list">880</field>

  <field action="replace" tag="12" split="occ"><pft>ref(['ARTIGO']val(v4001^r),@PROC_SPLIT_MST.PFT,(v12/))</pft></field>
  <field action="replace" tag="12" split="occ"><pft>ref(['ARTIGO']val(v4001^r),@PROC_SPLIT_MST.PFT,(v12/))</pft></field>
  <call name="isXML"><pft>ref(['ARTIGO']val(v4001^r),@PROC_SPLIT_MST.PFT,v702)</pft></call>

  <proc>
    <pft>
	   	'd9999',
		if p(v4001^f) and v4001^f = '1' then 
	        (|<9999>|v12|</9999>|/)
		else
			if instr(v12,'~')=0 then 
				(|a9999~|v12|~|/) 
			else 
				if instr(v12,'{')=0 then 
					(|a9999{|v12|{|/) 
				else 
					('a9999~Invalid caracter in article title~'/) 
				fi 
			fi		fi, 
    </pft>  
  </proc>

  <call name="CreateArticleTitleXML"><pft>(v9999/)</pft></call>
</function>

<function name="CreateIssueInfoXML" action="replace" tag="4001">
	<field action="import" tag="list">5011</field>
<!-- Generate XML for Title of Article
     4001 - MFN -->

   <display>
    <pft>
	if p(v5011) then
	 ref(['NEWISSUE']val(v4001),
	  '<ISSUE',
 	  ' NUM="beforeprint"' 
	  | VOL="|v31|"|,
	  | SUPPL="|v131|"|,
	  | SUPPL="|v132|"|,
	  | COMPL="|v41|"|,

	  | PUBDATE="|v65|"|,
	  ,' STATUS="',v742,'"'
	  '>'/)
	else
	 ref(['NEWISSUE']val(v4001),
	  '<ISSUE',
	  | VOL="|v31|"|,
 	  if p(v32) then ' NUM="',s(mpu,v32,mpl),'"' fi,	  
/*	  | NUM="|v32|"|,	*/
	  | SUPPL="|v131|"|,
	  | SUPPL="|v132|"|,
	  | COMPL="|v41|"|,
	  | PUBDATE="|v65|"|,
	  ,' STATUS="',v742,'"'
	  '>'/)
	  fi
	</pft>	
   </display>
</function>

<function name="GetLanguage" action="replace" tag=4001>
<!-- Determines the language in which some field is going to be shown
     4001 (1st line) - Interface Language
	      (2nd line) - International Language
	     other lines - The field
	 Returns - 
	 4010 - The language in which the field is going to be shown -->

   <field action="replace" tag="4003" split="occ"><pft>(v4001/)</pft></field> 
   <field action="replace" tag="4002"><pft>v4003[1]</pft></field>
   <field action="replace" tag="4004"><pft>v4003[2]</pft></field>
   <!-- field action="delete" tag="4003">1</field>
   <field action="delete" tag="4003">1</field -->
   
   <field action="replace" tag="4011">
    <pft>if not s(mpu,v4003):s(mpu,'^l'v4002) then 
	      if s(mpu,v4003):s(mpu,'^l'v4004) then mpl,v4004 else mpl,v4003^l[1] fi
		 else mpl,v4002 fi</pft>
   </field>

   <field action="replace" tag="4011">
    <pft>if a(v4011) and v4003:'^l' then (if p(v4003^l) then v4003^l,break fi) fi</pft>
   </field>   
   
   <return action="replace" tag=4010><pft>if p(v4011) then v4011 else '0' fi</pft></return>
</function>

<function name="CreateIssueTitleXML" action="replace" tag=4001>
<!-- Generate XML for Issue Title 
     ^r - MFN 
	 ^l - Interface Language 
	 ^i - International Language -->
     
   <field action="replace" tag="33" split="occ"><pft>ref(['NEWISSUE']val(v4001^r),(v33/))</pft></field>
   
   <call name="GetLanguage"><pft>v4001^l/v4001^i/(v33/)</pft></call>   
   <field action="replace" tag="9000">
    <pft>(if s(mpu,v33^l)=s(mpu,v4010[1]) then mpl,v33^* fi)</pft>
   </field>
   
   <display>
	<pft>("<TITLE><![CDATA["v9000"]]></TITLE>"/)</pft>
   </display>
   
   <label>RETURN</label>
</function>

<function name="CreateIssueStripXML" action="replace" tag=4001>
  <field action="import" tag="list">5011</field> <!-- fixed -->
  <field action="replace" tag="5011"><pft>if p(v5011) then '1' fi</pft></field> <!-- fixed -->

<!-- Generate XML for City of Issue 
     ^r - MFN 
	 ^l - Interface Language 
	 ^i - Standard Language -->
	 
  <field action="replace" tag="43" split="occ">
   <pft>ref(['NEWISSUE']val(v4001^r),(v43/))</pft>
  </field>
  
  <call name="GetLanguage"><pft>if p(v4001^l) then v4001^l/v4001^i/(v43/) fi</pft></call>
  <field action="replace" tag="9000" split="occ">
   <pft>if p(v4001^l) then 
   			(if s(mpu,v43^l)=s(mpu,v4010[1]) then mpl,v43 fi)
		else 
			(v43/)
		fi
	</pft>
  </field>
   	
  <display>
	<pft>('<STRIP LANG="',v9000^l,'">',/
	     '<SHORTTITLE><![CDATA[',v9000^t,']]></SHORTTITLE>'/,
  		 '<VOL>',v9000^v,'</VOL>',/,
		 '<NUM>',if a(v5011[1]) then v9000^n else 'beforeprint' fi,'</NUM>',/,
		 |<SUPPL>|v9000^w|</SUPPL>|,/,
		 |<SUPPL>|v9000^s|</SUPPL>|,/,
	     '<CITY>',v9000^c,'</CITY>',/,
		 '<MONTH>',v9000^m,'</MONTH>',/,
		 '<YEAR>',v9000^a,'</YEAR>',/,
		 '</STRIP>'/),#</pft>
  </display>
   
  <label>RETURN</label>
</function>

<function name="CreateErrorXML" action="replace" tag=4001>
<!-- Generate XML for Error
     ^c - Error Code 
	 ^l - Interface Language 
	 ^p - Parameters -->

  <field action="import" tag="list">7008/7060</field> <!-- fixed -->

  <display>
   <pft>
    '<ERROR>'/,
   </pft>
  </display>

  <call name="CreateControlInfoXML"><pft>'^l',v4001^l,'^siso</pft></call>
  
  <display>
   <pft>
  	  '<LANG>'v4001^l'</LANG>'/,
	  '<CODE>'v4001^c'</CODE>'/,
	  '<PID>'v4001^p'</PID>'/,
	  |<EMAIL>|v7008|</EMAIL>|/,
	'</ERROR>'/
   </pft>
  </display>
  
  <flow action="exit">1</flow> 
</function>

<!-- DebugMode
  OFF      - Turns Off debug mode
  XML      - Displays xml
  ON       - Trace On
  TABLE    - Trace Table
  BR       - Trace BR
  VERIFICA - Gathers informations from o/h/f records (db=artigo) when page=issuetoc
  -->
<function name="DebugMode" action="replace" tag="4000">
	
	<display>
		<pft>
			'Content-type:',
			if v4000 = 'OFF' or v4000 = 'VERIFICA' then
				'text/xml',
			else
				'text/html',
			fi,/#
		</pft>
	</display>

	<flow action="jump">
		<pft>
			if v4000 = 'ON' or v4000 = 'TABLE' or v4000 = 'BR' then
				v4000
			else
				'COMMON'
			fi
		</pft>
	</flow>
	
	<label>ON</label>
	<trace>On</trace>	
	<flow action="jump">COMMON</flow>
	
	<label>TABLE</label>
	<trace>Table</trace>	
	<flow action="jump">COMMON</flow>

	<label>BR</label>
	<trace>BR</trace>	
	<flow action="jump">COMMON</flow>

	<label>COMMON</label>
	
	<display>
		<pft>
			if v4000 = 'OFF' or v4000 = 'VERIFICA' then
				'<?xml version="1.0" encoding="ISO-8859-1"?>'/#
			fi
		</pft>
	</display>
</function>

<function name="CreateStatParamXML" tag="4000" action="replace">
<!-- CreateStatParam
  ^s - Log Start Date
  ^c - Log Current (Last) Date
  ^o - Order (filter by order)
  ^i - Initial date (filter by range of dates)
  ^f - Final date (filter by range of dates)
  ^a - Number of access (lower limit)
  -->    
    <display>
        <pft>
            ' <STATPARAM>',/
            '  <START_DATE>'v4000^s'</START_DATE>',/
            '  <CURRENT_DATE>'v4000^c'</CURRENT_DATE>',/
            '  <FILTER>',/
            |   <ORDER>|v4000^o|</ORDER>|,/
            |   <INITIAL_DATE>|v4000^i|</INITIAL_DATE>|,/
            |   <FINAL_DATE>|v4000^f|</FINAL_DATE>|,/
            |   <NUM_ACCESS>|v4000^a|</NUM_ACCESS>|,/
            '  </FILTER>',/
            ' </STATPARAM>',/#
        </pft>
    </display>
</function>

<function name="CreateMySQLErrorXML" tag="4000" action="replace">
<!-- CreateMySQLErrorXML
  ^l - Interface language
  ^e - Error Code
-->    
    <field action="import" tag="list">7008/7040</field>
    <display>
        <pft>            
            '<MYSQL_ERROR>',/
        </pft>
    </display>
            
    <call name="CreateControlInfoXML"><pft>'^l',v4000^l,'^siso</pft></call>
    
    <display>
        <pft>          
            '<LANG>'v4001^l'</LANG>'/,
            '<ERRORCODE>'v4000^e'</ERRORCODE>',/
        	|<EMAIL>|v7008|</EMAIL>|/,
            '</MYSQL_ERROR>',/
        </pft>
    </display>    

    <flow action="exit">1</flow>         
</function>

<function name="PossibleNoAccessXML" action="replace" tag=4001>
<!-- PossibleNoAccessXML - To Create the List of Numbers of Access in Journal Statistics
   4001 - 
     ^m - Max. number of access
     ^l - List of Numbers of Access -->

 <flow action="jump"><pft>if val(v4001^m)>0 then 'CONTINUE' fi</pft></flow>
 <return>1</return>
 
 <label>CONTINUE</label>
 <display><pft>'<POSSIBLE_NO_ACCESS MAX="'v4001^m'">'/</pft></display>
 
 <field action="replace" tag="5000" split="occ"><pft>replace(v4001^l,',',s(#))</pft></field>  

 <display><pft>(|<OPTION>|v5000|</OPTION>|/)</pft></display>
 
 <display><pft>'</POSSIBLE_NO_ACCESS>'/#</pft></display>
</function>

<function name="CreateQueryResultPagesXML" action="replace" tag="4001">
<!-- 4001^c - Current Page 
     4001^l - Number of Lines Per Page 
	 4001^t - Total Number of Pages -->
 
 <flow action="jump"><pft>if val(v4001^t)>0 then 'CONTINUE' fi</pft></flow>
 <return>1</return>
 
 <label>CONTINUE</label>
 <display>
  <pft>'<QUERY_RESULT_PAGES CURRENT="'v4001^c,'"',
                            if val(v4001^c)>1 then ' PREVIOUS="',f(val(v4001^c)-1,1,0),'"' fi,
							if val(v4001^c)<val(v4001^t) then ' NEXT="',f(val(v4001^c)+1,1,0),'"' fi,
                            ' TOTAL="'v4001^t'"',
							' NLINES="'v4001^l'"/>'/#</pft>
 </display>
</function>

<function name="CreateArtIssueInfoXML" action="replace" tag=4001>
<!-- Generate XML for IssueInfo of Article
	 4001^* - mfn 
	 4001^l - Interface Language 
	 4001^i - Standard Language -->

    <do task="mfnrange">
        <parm name="db">NEWISSUE</parm>
        <parm name="from"><pft>v4001^*</pft></parm>
        <parm name="count">1</parm>

        <loop>
		    <field action="import" tag=4001>4001</field>
            <call name="GetLanguage"><pft>v3000/v3003/(v43/)</pft></call>

            <field action="replace" tag="9000">
            	<pft>(if s(mpu,v43^l)=s(mpu,v4010[1]) then mpl,v43^c,break fi)</pft>				
            </field>

            <display>
            	<pft>
                	'  <ISSUEINFO',
            		| VOL="|v31|"|,
            		| NUM="|v32|"|, 
            		| SUPPL="|v131|"|,
            		| SUPPL="|v132|"|,
                    if p(v65) then 
                    | YEAR="|v65*0.4|"|,
                    | MONTH="|v65*4.2|"|,
                    fi
                    '>'/,
                </pft>
            </display>
            
            <call name="CreateIssueStripXML"><pft>'^r'v4001^*,'^l'v4001^l,'^i'v4001^i</pft></call>
     
            <display>
                <pft>
                    '   <ISSN>',v35,'</ISSN>'/
            		'  </ISSUEINFO>'/#
                </pft>
            </display>
        </loop>
    </do>
</function>

<function name="GetSectionName" action="replace" tag=4001>
<!-- Get the name of the section in a given language
     4001^l - Interface Language
	 4001^c - Section Code 
	 4001^p - Issue ID
	 4001^i - International Language
	 Returns: 
	 4010 - Section Name -->


	<field action="replace" tag="49" split="occ"><pft>ref(['ARTIGO']l(['ARTIGO'],'Y',v4001^p),@PROC_SPLIT_MST.PFT,(v49/))</pft></field>
	<field action="replace" tag="4008"><pft>(if s(mpu,v49^c)=s(mpu,v4001^c[1]) then mpl,'^l'v49^l,'^t'v49^t/ fi)</pft></field>

	<call name="GetLanguage"><pft>v4001^l/v4001^i/v4008</pft></call>
  
	<field action="replace" tag="4009" split="occ"><pft>v4008</pft></field>
  
	<field action="replace" tag="4010">
		<pft>(if s(mpu,v4009^l)=s(mpu,v4010[1]) then mpl,v4009^t fi)</pft>
	</field>
 
	<return action="replace" tag="4010"><pft>v4010</pft></return>
</function>

<function name="CreateArticleTitleOrSectionXML" action="replace" tag="4000">
    <!--
    Prints article title if present. Otherwise section name.
    v4000 - mfn 
    -->
	<field action="import" tag="list">3000,3003,3012</field>

    <do task="mfnrange">
		<parm name="db">ARTIGO</parm>	
        <parm name="from"><pft>v4000</pft></parm>
        <parm name="count">1</parm>

        <loop>
            <display><pft>@PROC_SPLIT_MST.PFT,</pft></display>
        	<field action="import" tag="list">3000,3003,3012</field>
        
            <flow action="jump">
                <pft>if a(v12) then 'SECTION' fi</pft>
            </flow>
    
            <call name="isXML"><pft>v702</pft></call>
            <call name="CreateArticleTitleXML"><pft>(v12/)</pft></call>
            <flow action="skip">Quit</flow>
    
            <label>SECTION</label>
            <call name="GetSectionName">
                <pft>
                    if p(v49) then
                        '^l',v3000,
                        '^c',v49,
                        '^s',f( l( ['NEWISSUE']'Y',mid(v880,2,17) ), 1, 0 )
                        '^i',v3003,   
                    fi                 
                </pft>
            </call>
    
            <display>
                <pft>
                '  <SECTION><![CDATA[',v4010,']]></SECTION>'/
                </pft>
            </display>        
        </loop>
    </do>
</function>

<function name="CreateLanguageXML" action="replace" tag="4001">
<!-- Create Article's Language List 
    4001^m - mfn
    4001^s - script
    4001^l - Interface Language 
	4001^i - International Language 
    4001^t - txt language-->

  <field action="import" tag="list">7009/7061</field>  <!--fixed-->
	<!-- fixed 20040910 todo o trechp inserindo a funcao PROC_SPLIT_MST_range e substituindo os ref e lookups -->

  <field action="replace" tag="41" split="occ"><pft>ref(['ARTIGO']val(v4001^m),@PROC_SPLIT_MST.PFT,(v41/))</pft></field>
  <field action="replace" tag="241" split="occ"><pft>ref(['ARTIGO']val(v4001^m),@PROC_SPLIT_MST.PFT,(v241/))</pft></field>
  <field action="replace" tag="264" split="occ"><pft>ref(['ARTIGO']val(v4001^m),@PROC_SPLIT_MST.PFT,v264)</pft></field>

  <field action="replace" tag="4010" split="occ"><pft>ref(['ARTIGO']val(v4001^m),@PROC_SPLIT_MST.PFT,(v83^l/))</pft></field>
  <field action="replace" tag="4002"><pft>ref(['ARTIGO']val(v4001^m),@PROC_SPLIT_MST.PFT,v880)</pft></field>
  <field action="replace" tag="12" split="occ"><pft>ref(['ARTIGO']val(v4001^m),@PROC_SPLIT_MST.PFT,(v12/))</pft></field>
  <field action="replace" tag="40" split="occ"><pft>ref(['ARTIGO']val(v4001^m),@PROC_SPLIT_MST.PFT,(v40/))</pft></field>
  <field action="replace" tag="880" split="occ"><pft>ref(['ARTIGO']val(v4001^m),@PROC_SPLIT_MST.PFT,(v880/))</pft></field>

  <field action="replace" tag="4002"><pft>v880</pft></field>
  <field action="replace" tag="4004"><pft>v40</pft></field>

    
  
  <!-- 4003 - article's languages from keys -->
  <field action="delete" tag="4003">ALL</field>
  
  <!-- If not found language from key gets article's language from header -->
  <field action="replace" tag="4003" split="occ"><pft>if a(v4003) then (v4004/) fi</pft></field>

  <!-- removes current language from list -->
  <field action="delete" tag="4010">
    <pft>
        (if v4001^s[1] = 'sci_abstract' then
            if v4001^t[1] = v4010 then
                f(iocc,1,0),break
            fi
        fi)
    </pft>
  </field>

  <!-- removes current language from list -->
  <field action="delete" tag="4003">
    <pft>
        (if v4001^s[1] = 'sci_arttext' then
            if v4001^t[1] = v4003 then
                f(iocc,1,0),break
            fi
        fi)
    </pft>
  </field>
  <!--
  <display>
   <pft>
    ' <LANGUAGES MAXLINES="',
        f(
            rmax(
                f(nocc(v4010),1,0),',',
                f(nocc(v4003),1,0),',',
                f(nocc(v4005),1,0)
            ),1,0),
    '">'/
    
    if p(v4010) then
    '  <ABSTRACT_LANGS>'/,
    (|   <LANG>|v4010|</LANG>|/)
    '  </ABSTRACT_LANGS>'/
    fi
    
    '  <ART_TEXT_LANGS>'/,
    (|   <LANG>|v4003|</LANG>|/)
    
    '  </ART_TEXT_LANGS>'/

    if p(v4005) then
    '  <PDF_LANGS>'/
    '   <LANG>'v4005'</LANG>'/
    '  </PDF_LANGS>'/
    fi
        
    ' </LANGUAGES>'/    
   </pft>
  </display>
  -->
  <display>
   <pft>
    ' <LANGUAGES MAXLINES="',
        f(
            rmax(
                f(nocc(v4010),1,0),',',
                f(nocc(v4003),1,0),',',
                f(nocc(v4005),1,0)
            ),1,0),
    '">'/
   </pft>
  </display>
  
  <field action="delete" tag="9999">ALL</field>
  <call name="OrdenaLanguage"><pft>v4001^l/,(v4010/)</pft></call>

  <display>
   <pft>
    if p(v4010) then
    '  <ABSTRACT_LANGS>'/,
    (|   <LANG>|v9999|</LANG>|/)
    '  </ABSTRACT_LANGS>'/
    fi
   </pft>
  </display>

  <call name="showText"><pft>v264</pft></call>
  <flow action="jump"><pft>if v8264='no' then 'NO_TEXT_AVAILABLE' fi</pft></flow>
  <field action="delete" tag="9999">ALL</field>
  <call name="OrdenaLanguage"><pft>v4001^l/,(v4003/)</pft></call>
    
	<!-- fixed -->
	<call name="TestTranslationPresence"><pft>v880/,(if v40[1]<>v12^l then |^l|v12^l/ fi),'^d'v7041/</pft></call>
	
  <!-- fixed -->
  <display>
   <pft>if v41='pr' then

   ,else

    '  <ART_TEXT_LANGS>'/,
    (|   <LANG>|v9999|</LANG>|/)
	v7999	
    '  </ART_TEXT_LANGS>'/
	,fi
   </pft>
  </display>

  <!-- call name="OrdenaLanguage"><pft>v4001^l/,(v4003/)</pft></call -->

	<!-- fixed -->
	<call name="TestTranslationPresence"><pft>v880/,'^o',v40,(|^l|v12^l/),'^d'v7022/,'^epdf'/</pft></call> 
  <display>
   <pft>

    /* fixed 20040916 if p(v4005) then */ 
    if p(v7999) then 
    '  <PDF_LANGS>'/
	v7999
    '  </PDF_LANGS>'/
    fi
   </pft>
  </display>

        
  <label>NO_TEXT_AVAILABLE</label>
  <call name="PressReleaseLanguages"><pft>(if v241^t='pr' then '^i',v241^i,'^d'v7041[1]/ fi),(if v41='pr' then '^i',v880,'^o',v40,'^d'v7041 fi)</pft></call>
  <display>
   <pft>
    ' </LANGUAGES>'/    
   </pft>
  </display>
</function>

<function name="OrdenaLanguage" tag="4000" action="replace" split="occ">
   <field action="replace" tag="4001"><pft>v4000[1]</pft></field>
   <field action="delete" tag="4000">1</field>
   <flow action="jump">
      <pft>
         if v4000 : v4001 then
         else
            'END_FUNCTION'
         fi
      </pft>
   </flow>
   
   <field action="delete" tag="4000">
      <pft>
         (if v4000 = v4001[1] then
            f(iocc,1,0),break
         fi)
      </pft>
   </field>
   
   <field action="replace" tag="4000" split="occ"><pft>v4001/,(v4000/)</pft></field>
   
   <label>END_FUNCTION</label>
   
   <return action="replace" tag="9999" split="occ"><pft>(v4000/)</pft></return>
</function>

<function name="CreateLattesGroupXML" action="replace" tag="4001">
<!-- Create XML    
-->
   <field action="statusdb" tag="2001">LATTES</field>
	
   <flow action="jump">
	 <pft>if a(v2001^n) then 'EXIT_LATTES' fi</pft>
   </flow>

	<!-- Gets authors list -->
	<field action="replace" tag="10" split="occ"><pft>ref(['ARTIGO']l(['ARTIGO'],'HR=',v4001),@PROC_SPLIT_MST.PFT,(v10/))</pft></field>
	
	<flow action="jump"><pft>if a(v10) then 'EXIT_LATTES' fi</pft></flow>
	
	<!-- Remove HTML tags from authors list -->
	<proc>
		<pft>
        	'd9999',
			(|<9999>|v10|</9999>|/)
		</pft>
	</proc>
	
	<!-- Generate search expression SURNAME1, NAME1 OR SURNAME2, NAME2 OR ... -->
	<field action="replace" tag="3001">
		<pft>
		(if p(v9999^s) or p(v9999^n) then,
			if iocc > 1 then ' OR ' fi, '"',replace(v9999^s,' .','.'),', ',replace(v9999^n,' .','.'),'"'
		fi)
		</pft>
	</field>
	
	<!--display><pft>"Expression = "v3001</pft></display-->
	<do task="search">
		<parm name="db">LATTES</parm>
		<parm name="expression"><pft>v3001</pft></parm>
				
		<display><pft>' <LATTES>'/</pft></display>
		<loop>

			<display>
				<pft>
					'  <AUTHOR HREF="',v4,'">',v3,'</AUTHOR>',/
				</pft>
			</display>
		</loop>			
		<display><pft>' </LATTES>'/</pft></display>
	</do>
	<label>EXIT_LATTES</label>
</function>

<function name="CreateProjetoFAPESP" action="replace" tag="4001">
   <field action="statusdb" tag="2001">PROJFAPESP</field>

        <field action="replace" tag="10" split="occ"><pft>,ref(['PROJFAPESP']l(['PROJFAPESP'],'SCI=',v4001),('<PROJETO><title><![CDATA[',v88^n,']]></title><url>',v88^u,'</url></PROJETO>',/))</pft></field>

        <flow action="jump"><pft>if a(v10) then 'EXIT_FAPESP' fi</pft></flow>

	<display><pft>'<FAPESP>'/,replace(v10,'&','&amp;'),'</FAPESP>'/</pft></display>

        <label>EXIT_FAPESP</label>
</function>

<function name="CreateClinicalTrials" action="replace" tag="4001">
   <do task="search">
      <parm name="db">ARTIGO</parm>
      <parm name="expression"><pft>'HR=',v4001</pft></parm>
      <parm name="count">1</parm>

      <display><pft>'<CLINICALTRIALS>'</pft></display>
      <loop>
         <display>
            <pft>
               ,if p(v770) then,
                  ,('<trial provider="',v770^*,'" id="',v770^a,'" url="',replace(replace(v770^u,'&amp;','&'),'&','&amp;'),'"/>'),
               ,fi,
            </pft>
         </display>
      </loop>
      <display><pft>'</CLINICALTRIALS>'</pft></display>
   </do>
</function>

<function name="PROC_SPLIT_MST" action="replace" tag="4001">
<!-- fixed 20040122 - corrige problema de leitura da base ao executar a proc PROC_SPLIT_MST. A soluo usada foi criar uma funo que faz o mesmo que a proc -->
<!-- fixed 20040910 - melhorado -->
<flow action="jump"><pft>if p(v4001^m) then 'splited' fi</pft></flow>
 <do task="mfnrange">
  <parm name="db">ARTIGO</parm>
  <parm name="from"><pft>v4001</pft></parm>
  <parm name="count">1</parm>
  <loop>
   <field action="replace" tag="4001"><pft>v32701</pft></field>   
   <field action="export" tag="list">4001</field>   
   <field action="export" tag="list">1/999</field>   
  </loop>
 </do>
  <file action="close" type="database">ARTIGO</file>
<flow action="jump"><pft>if a(v4001^m) then 'no_splited' fi</pft></flow>
 <label>splited</label>
 <do task="mfnrange">
  <parm name="db"><pft>v4001^*</pft></parm>
  <parm name="from"><pft>v4001^m</pft></parm>
  <parm name="count">1</parm>
  <loop>
  <!--display><pft>ALL</pft></display-->
   <field action="export" tag="list">1/999</field>   
  </loop>
 </do>
 <file action="close" type="database"><pft>v4001^*</pft></file>
 <label>no_splited</label>
<return action="replace" tag="list">1/999</return>   
</function>

<function name="PROC_SPLIT_MST_search" action="replace" tag="4001">
<!-- fixed 20040910 - criado -->

	<do task="search">
	   	<parm name="db">ARTIGO</parm>
		<parm name="expression"><pft>v4001</pft></parm>
		<parm name="count">1</parm>
		
		<loop>
		 <field action="export" tag="list">1/999,32701</field>
		</loop>
	</do>
	
	<call name="PROC_SPLIT_MST"><pft>v32701</pft></call>
   <return action="replace" tag="list">1/999</return>   
</function>

<function name="PROC_SPLIT_MST_keyrange"action="replace" tag="1003">
<!-- fixed 20040910 - criado -->
 <do task="mfnrange">
  <parm name="db">ARTIGO</parm>
  <parm name="from"><pft>v1003</pft></parm>
  <parm name="count">1</parm>
  <loop>
		 <field action="export" tag="list">1/999,32701</field>
  </loop>
 </do>
 <call name="PROC_SPLIT_MST"><pft>v32701</pft></call>
 <return action="replace" tag="list">1/999</return>   
</function>

<function name="getIssueDir" action="replace" tag="4900">
<!-- fixed 20040910 - criado mas nao usado ...-->
	<do task="search">
    	<parm name="db">TITLE</parm>
		<parm name="expression"><pft>'LOC=',mpu,mid(v4900,2,9),mpl</pft></parm>
		<loop>
			<field action="export" tag="list">68</field>
		</loop>
	</do>
	<do task="search">
    	<parm name="db">NEWISSUE</parm>
		<parm name="expression"><pft>'Y',mid(v4900,2,size(v4900)-5-1)</pft></parm>
		<loop>
			<field action="export" tag="list">31,32,131,132</field>
		</loop>
	</do>
	<!-- Get the lowercase siglum of the serial >
	<field action="replace" tag="9000">
		<pft>
		ref(['TITLE']l(['TITLE'],'LOC=',mpu,mid(v4900,2,9),mpl),v68),			
		</pft>
	</field-->
	
	<!--display><pft>' sigla: ',v9000</pft></display-->

	<!-- Gets the volumn number, issue number and supplement number >
	
	<field action="replace" tag="9001">
		<pft>
			ref( ['NEWISSUE'] l( ['NEWISSUE'],'Y',mid(v4900,2,size(v4900)-5-1) ),
				"v"v31,"n"v32,"s"v131,"s"v132 )
		</pft>
	</field-->

   <return action="replace" tag="list">68,31,32,131,132</return>   


</function>

<function name="getDOIDB" action="replace" tag="880">
	<field action="import" tag="7011">7011</field>
	<field action="replace" tag="9000"><pft>ref(['ARTIGO']l(['ARTIGO'],'Y',v880*1.17),@PROC_SPLIT_MST.PFT,|v|v31,|s|v131,|n|v32,|s|v132)</pft></field>
	<field action="replace" tag="9001"><pft>ref(['TITLE']l(['TITLE'],s('LOC=',v880*1.9)),v68)</pft></field>
	<field action="replace" tag="9800"><pft>v7011,'doi/',v9001|/|,v9000|/|,v9000,</pft></field>

	<field action="statusdb" tag="9901"><pft>v9800</pft></field>

	<return action="replace" tag="9800"><pft>
			if v9901^s : 'i' then 
				v9800
			else
				'no_doi_db'
			fi
		</pft></return>   
 </function>
<function name="getDOIfromDB" action="replace" tag="880">
	<field action="import" tag="list">7011,9800</field>
	<call name="getDOIDB"><pft>if a(v9800) then v880 fi</pft></call>
	<field action="export" tag="list">9800</field>

	<return action="replace" tag="900"><pft>
		if p(v9800) and v9800<>'no_doi_db' then ref([v9800]l([v9800],v880),v1) fi
	</pft></return>   
 </function>
 <function name="getDOILink" action="replace" tag="880">
	<field action="import" tag="list">7011,237,881,9800</field>
    <call name="getDOI"><pft>v880</pft></call>

	<field action="export" tag="list">9800</field>
	<return action="add" tag="9999"><pft>
		if p(v9800) and v9800<>'no_doi_db' then ref([v9800]l([v9800],v880),(if v999^u<>'' then '<a href="',v999^u,'">',v999^l,'</a>'/ fi)) fi
	</pft></return>   
 </function>
 <function name="displayDOIAttribute" action="replace" tag="880">
	<field action="import" tag="list">7011,237,881,9800</field>
    <call name="getDOI"><pft>v880</pft></call>
	
	<display><pft>| DOI="|v237|"|,</pft></display>
	<display><pft>| oldpid="|v881|"|</pft></display>
	<field action="export" tag="9800">9800</field>
	<field action="export" tag="list">237</field>

 </function>
<function name="getDOI" action="replace" tag="880">
    <field action="import" tag="list">7011,237,9800</field>

    <flow action="jump"><pft>if p(v237) then 'ok' fi</pft></flow>
    
    <!-- consulta a base doi/query -->
    <field action="replace" tag="237"><pft>if a(v237) then ref(['DOI']l(['DOI'],'pid=',v880),v237^*) fi</pft></field>
	<field action="replace" tag="237"><pft>if a(v237) then ref(['DOIQUERY']l(['DOIQUERY'],'PID=',v880),v237) fi</pft></field>
	
	
    <flow action="jump"><pft>if p(v237) then 'ok' fi</pft></flow>
	<field action="replace" tag="881"><pft>ref(['ARTIGO']l(['ARTIGO'],'HR=',v880),@PROC_SPLIT_MST.PFT,v881)</pft></field>
    <field action="replace" tag="237"><pft>if a(v237) and p(v881) then ref(['DOI']l(['DOI'],'pid=',v881),v237^*) fi</pft></field>
	<field action="replace" tag="237"><pft>if a(v237) and p(v881) then ref(['DOIQUERY']l(['DOIQUERY'],'PID=',v881),v237) fi</pft></field>
	                                    
    <flow action="jump"><pft>if p(v237) then 'ok' fi</pft></flow>
	<field action="replace" tag="891"><pft>ref(['ARTIGO']l(['ARTIGO'],'HR=',v880),@PROC_SPLIT_MST.PFT,v891)</pft></field>
    <field action="replace" tag="237"><pft>if a(v237) and p(v891) then ref(['DOI']l(['DOI'],'pid=',v891),v237^*) fi</pft></field>
	<field action="replace" tag="237"><pft>if a(v237) and p(v891) then ref(['DOIQUERY']l(['DOIQUERY'],'PID=',v891),v237) fi</pft></field>
	
    <flow action="jump"><pft>if p(v237) then 'ok' fi</pft></flow>
	<!-- n?o encontrando, consulta a base de doi antiga  -->
	

	<call name="getDOIfromDB"><pft>if p(v891) then v891 else if p(v881) then v881 else v880 fi fi</pft></call>
	<field action="replace" tag="237"><pft>v900</pft></field>

    <label>ok</label>
    <call name="fixDOI"><pft>v237</pft></call>
	<field action="export" tag="list">237,9800</field>


 </function>
 <function name="fixDOI" action="replace" tag="237">
	<return action="replace" tag="237"><pft>replace(replace(replace(replace(v237,'http://dx.doi.org/',''),'doi:',''),'DOI:',''),' ','')</pft></return>
 </function>
 <!--function name="displayDOI" action="replace" tag="237">
	<field action="import" tag="list">237</field>
	<call name="fixDOI"><pft>v237</pft></call>
	<display><pft>|<doi>|v237|</doi>|/</pft></display>
 </function-->
<!-- ============================================================================ -->
<!--  function issueHasArticles                                              -->
<!--                                                                              -->
<!--  Gets the pid (issnyyyynnnn) of the issue					          -->
<!--                                                                              -->
<!--  Argument:                                                                   -->
<!--     The ISSN of the current issue.											  -->
<!--                                                                              -->
<!--  Return value:                                                               -->
<!--     If found, returns the pid of the issue in the tag 9036. Otherwise   -->
<!--  returns nothing.                                                            -->
<!--  this replaces: l(['ARTIGO'],'HR=S',mpu,v4901*1,mpl,'00001') > 0             -->
<!--  because since submission online it is not guaranteed there is always an     -->
<!--  article which pid has the last 5 digits equal to '00001'					 -->
<!-- ============================================================================ -->
<function name="issueHasArticles" action="replace" tag="4901">
        <field action="replace" tag="9036"><pft>if l(['ARTIGO']'sm=',v4901,'-001')>0 then v4901 fi</pft></field>
        <flow action="jump"><pft>if p(v9036) then 'EXIST' fi</pft></flow>
        <do task="search">
           <parm name="db">ARTIGO</parm>
           <parm name="expression"><pft>'SM='v4901,'$'</pft></parm>
           <parm name="count">1</parm>

           <loop>
                        <display><pft>@PROC_SPLIT_MST.PFT</pft></display>
                        <field action="replace" tag="4902"><pft>v121</pft></field>
                        <field action="export" tag="4902">4902</field>
                </loop>
        </do>

        <field action="replace" tag="9036"><pft>if p(v4902) then v4901, fi,</pft></field>

        <label>EXIST</label>
        <return action="replace" tag="9036">
<pft>
,v9036,
                </pft>
        </return>
</function>


<function name="isXML" action="replace" tag="702">
	<field action="replace" tag="8000"><pft>replace(mid(v702,size(v702)-3,4),'.XML','.xml')</pft></field> 
	<return action="replace" tag="8000"><pft>
		if v8000='.xml' then 
			,'XML',  
		else
			if v8000='.PDF' or v8000='.pdf' then
				,'XML',
			else
				,'BODY',
			fi
		fi
	</pft></return> 
</function>

<function name="showText" action="replace"  tag="264">
	<field action="replace" tag="264"><pft>mpu,v264,mpl</pft></field>
	<return action="replace" tag="8264">
		<pft>if p(v264) then 
				if v264='ND' then
					,'no',
				else
					if val(v264)>val(s(date)*0.8) then 
						,'no', 
					,else
						,'yes'
					fi
				fi
			else
				,'yes',
			fi

		</pft>
	</return>
</function>
<function name="checkNewHome" action="replace" tag="4000">

	<do task="import">
	    <parm name="file">../htdocs/rep.def.php</parm>
		<parm name="type">RLine</parm>
    	<loop>
			<field action="import" tag="list">4000</field>
			<field action="replace" tag="9936"><pft>f(val(v1)+100000,6,0)</pft></field>
			<field action="replace" tag="1"><pft>v9936*1.5</pft></field>
			<field action="replace" tag="9936"><pft>f(val(v4000^r)+100000,6,0)</pft></field>
			<field action="replace" tag="1000"><pft>v9936*1.5</pft></field>
			<field action="replace" tag="7047"><pft>if v1=v1000 then v3 fi</pft></field>
			<field action="replace" tag="7047"><pft>if p(v7047) then v7047,if instr(v7047,'?')>0 then '&amp;' else '?' fi,'lang=',v4000^l,  fi</pft></field>
			<field action="export" tag="list">7047</field>
			<flow action="skip"><pft>if p(v7047) then 'Quit' fi</pft></flow>
   		</loop>
		<field action="export" tag="list">7047</field>
	</do>
<return action="replace" tag="7047"><pft>v7047</pft></return>
</function>

<function name="getCreativeCommonsInfo" action="replace" tag="4000">
	<!-- ^llang'^f',lang,'_',page name,|^p|pid da pagina,'^s',site name,^c codigo licenca ^v version-->
	<field action="replace" tag="4000"><pft>if a(v4000^v) then v4000,'^v4.0' fi</pft></field>
	
	<field action="replace" tag="8803"><pft>if size(v4000^p)=23 then v4000^p fi</pft></field>
	<field action="replace" tag="8802"><pft>if size(v4000^p)=23 then v4000^p*1.17 else if size(v4000^p)=17 then v4000^p fi fi</pft></field>
	<field action="replace" tag="8801"><pft>if size(v4000^p)=23 then v4000^p*1.9 else if size(v4000^p)=17 then v4000^p*0.9 else v4000^p fi fi</pft></field>
	
	<flow action="jump"><pft>if size(v4000^p)=23 then 'article' fi</pft></flow>
	<flow action="jump"><pft>if size(v4000^p)=17 then 'issue' fi</pft></flow>
	<flow action="jump"><pft>if size(v4000^p)=9 then 'journal' fi</pft></flow>
	<flow action="jump"><pft>if p(v4000^c) then 'site' else 'other' fi</pft></flow>
	
	<label>article</label>
	<flow action="jump"><pft>if instr(ref(['ARTIGO']l(['ARTIGO'],'hr=',v8803),v702),'.xml')>0 then 'end' fi</pft></flow>

	<label>issue</label>
	<field action="replace" tag="1">issue</field>
	<field action="replace" tag="541"><pft>ref(['NEWISSUE']l(['NEWISSUE'],'Y',v8802),v541)</pft></field>
	<!-- se ausente v541, tentar o v540 que contm texto/html -->
	<field action="replace" tag="540" split="occ"><pft>if a(v541) then ref(['NEWISSUE']l(['NEWISSUE'],'Y',v8802),(if v540:':/creativecommons.org/licenses/' then v540,break, else if v540<>'' then 'nd',break, fi fi)) fi</pft></field>
	<flow action="jump"><pft>if p(v541) or p(v540) then 'license' fi</pft></flow>
	
	<label>journal</label>
	<field action="replace" tag="1">journal</field>
	<field action="replace" tag="541"><pft>ref(['TITLE']l(['TITLE'],'LOC=',v8801),v541)</pft></field>
	<field action="replace" tag="540" split="occ"><pft>if a(v541) then ref(['TITLE']l(['TITLE'],'LOC=',v8801),(if v540:':/creativecommons.org/licenses/' then v540,break, else if v540<>'' then 'nd',break, fi, fi)) fi</pft></field>
	<flow action="jump"><pft>if p(v541) or p(v540) then 'license' fi</pft></flow>
	
	<label>site</label>
	<field action="replace" tag="1">site</field>
	<field action="replace" tag="541"><pft>v4000^c</pft></field>
	<flow action="jump"><pft>if p(v541) or p(v540) then 'license' fi</pft></flow>
	
	<label>other</label>
	<field action="replace" tag="1">site</field>
	<call name="existeFile"><pft>'^p../bases/license/^f',v4000^l,'_general.txt'</pft></call>
	<flow action="jump"><pft>if a(v7999) then 'license' fi</pft></flow>

	<do task="import">
	    <parm name="file"><pft>'../bases/license/',v4000^l,'_general.txt'</pft></parm>
		<parm name="type">RLine</parm>
    	<loop>
			<field action="import" tag="list">540</field>
			<field action="add" tag="540"><pft>v1,"|"v2,"|"v3,"|"v4,"|"v5,"|"v6,"|"v7,"|"v8,"|"v9/</pft></field>
			<field action="export" tag="list">540</field>
   		</loop>
		<field action="replace" tag="540"><pft>(v540/)</pft></field>
	</do>
	
	<label>license</label>
	<field action="replace" tag="540">
		<pft>
			,if instr(v540,':/creativecommons.org/licenses/')>0 then
				mid(v540,instr(v540,':/creativecommons.org/licenses/')+size(':/creativecommons.org/licenses/'),size(v540))
			,fi
		</pft>
	</field>
	<field action="replace" tag="541">
		<pft>
			,if v540:'/deed' then
				,mid(v540,1,instr(v540,'/deed'))
			,else
				,if v540:'/"' then
			 		,mid(v540,1,instr(v540,'/"')),
				,else
					v540
				,fi
			,fi
		</pft>
	</field>
	<field action="replace" tag="541"><pft>replace(v541,'BY','by')</pft></field>
	<field action="replace" tag="541"><pft>replace(v541,'NC','nc')</pft></field>
	<field action="replace" tag="541"><pft>replace(v541,'ND','nd')</pft></field>
	<field action="replace" tag="541"><pft>replace(v541,'SA','sa')</pft></field>
	<field action="replace" tag="541"><pft>replace(v541,'IGO','igo')</pft></field>
	<field action="replace" tag="541"><pft>v541,if v541<>'nd' and v541<>'' and not v541:'/' and not v541:'igo' then '/',v4000^v fi</pft></field>
	<display>
		<pft>
			'<PERMISSIONS source="',v1,'">'/
			'<permissions>'/
			,if v541='nd' then
				'<!-- no license Creative Commons -->'
			,else
				,if v541<>'' then
					'<license license-type="open-access" href="http://creativecommons.org/licenses/',v541,'"></license>'
				,else
					'<!-- no license found -->'
				,fi
			,fi
			'</permissions>'/
			'</PERMISSIONS>'/
		</pft>
	</display>

	<label>end</label>
	
</function>

	<function name="CreateArticleTitleForReference" action="replace" tag="4000">
		<!--
		Prints article title if present. Otherwise section name.
		v4000 - mfn 
		-->
		<field action="import"	tag="list">3100</field>
		<do task="mfnrange">
			<parm name="db">ARTIGO</parm>	
			<parm name="from"><pft>v4000</pft></parm>
			<parm name="count">1</parm>

			<loop>
				<display><pft>@PROC_SPLIT_MST.PFT,</pft></display>
				<field action="import"	tag="list">3100</field>
				<call name="isXML"><pft>v702</pft></call>
				<!--field action="replace"	tag="1000">
					<pft>if v8000<>'XML' then '^i<![CDATA[^f]]>' fi</pft>
				</field-->

				<field action="replace"	tag="9040">
					<pft>v40</pft>
				</field>
				<field action="replace"	tag="9000">
					<pft>(if v9040[1]=v12^l then v12^* fi)</pft>
				</field>
				<field action="replace"	tag="9001">
					<pft>(if v9040[1]=v12^l then v12^s fi)</pft>
				</field>

				<display>
				  <pft>
                    if v706='f' then
                      ref(mfn-1,
                          if v706='h' then
					      '  <NOHTML-TITLE><![CDATA[',
					          ,v12^*[1],| |v12^s[1],
						    ,']]></NOHTML-TITLE>'/,
                          fi
                          )		
                    fi
				   </pft>
				</display>	

					
				<display>
					<pft>
						'  <ORIGINAL-TITLE><![CDATA[',v9000,']]></ORIGINAL-TITLE>'/#
						if p(v9001) then '  <ORIGINAL-SUBTITLE><![CDATA[',v9001,']]></ORIGINAL-SUBTITLE>'/# fi
					</pft>
				</display>	

				<field action="replace"	tag="9040">
					<pft>v3100</pft>
				</field>
				<flow action="jump"><pft>if v40=v9040 then 'END_FIND_TRANSLATIONS' fi</pft></flow>

				<field action="replace"	tag="9000">
					<pft>(if v9040[1]=v12^l then v12^* fi)</pft>
				</field>
				<field action="replace"	tag="9001">
					<pft>(if v9040[1]=v12^l then v12^s fi)</pft>
				</field>

				<display>
					<pft>
						'  <TRANS-TITLE><![CDATA[',v9000,']]></TRANS-TITLE>'/#
						if p(v9001) then '  <TRANS-SUBTITLE><![CDATA[',v9001,']]></TRANS-SUBTITLE>'/# fi
					</pft>
				</display>		
				<label>END_FIND_TRANSLATIONS</label>

				<display>
					<pft>
						'  <TITLE><![CDATA[',v9000,']]></TITLE>'/#
						if p(v9001) then '  <SUBTITLE><![CDATA[',v9001,']]></SUBTITLE>'/# fi
					</pft>
				</display>	

			</loop>
		</do>
	</function>
	
<function name="ArticleHasCorrections" action="replace" tag="4000">
	<field action="replace"	tag="880"><pft>v4000[1]</pft></field>
	<field action="import"	tag="list">241,237,41</field>

	<!-- documento: artigo | relacionado: errata -->
	<call name="RelatedDocument"><pft>if a(v241) then '^tcorrection^e','corrected-article'v880,| OR corrected-article|v237 fi</pft></call>
</function>



<function name="AllRelatedDocuments" action="replace" tag="4000">
	<field action="replace"	tag="880"><pft>v4000[1]</pft></field>
	<field action="import"	tag="list">241,237,41</field>

	<!-- documento => retratacao ->
	<call name="FindPIDbyExpression"><pft>'corrected-article'v880,| OR corrected-article|v237</pft></call>
	<call name="RelatedDocument"><pft>v9880,|^t|v241^t</pft></call>
	<field action="delete" tag="list">9880</field>

	<!-- documento => errata ->
	<call name="FindPIDbyExpression"><pft>'retracted-article'v880,| OR retracted-article|v237</pft></call>
	<call name="RelatedDocument"><pft>v9880,|^t|v241^t</pft></call>
	<field action="delete" tag="list">9880</field>

	<!-- artigo => pr -->
	<call name="RelatedDocument"><pft>if v241^t='pr' then v241^i fi,|^t|v241^t</pft></call>

	<!-- * => artigo -->
    <list action="load" type="list"><pft>(v241/)</pft></list>
    <do task="list">
        <field action=define tag="1001">Isis_Current</field>
        <field action=define tag="1002">Isis_Items</field>
        <field action=define tag="1">Isis_Item</field>
        <loop>
            <field action="import" tag="list">880</field>
            <call name="FindPIDbyDOI"><pft>if v1^t<>'pr' and v1^n='doi' then v1^i,'^p'v880 fi</pft></call>
            <call name="RelatedDocument"><pft>v9880,if a(v9880) then v1^i fi,|^t|v1^t</pft></call>
        </loop>
    </do>
    <list action="delete">now</list>

	<field action="delete" tag="list">9880</field>

</function>

<function name="RelatedDocument" action="replace" tag="4000">
	<display><pft>'<!-- RelatedDocument: ',v4000,' -->'/</pft></display>
	<flow action="jump"><pft>if v4000*0.1='^' then 'END' fi</pft></flow>

    <do task="search">
		<parm name="db">ARTIGO</parm>
		<parm name="expression"><pft>'HR='v4000^*</pft></parm>
		<parm name="count">1</parm>

        <loop>
        	<display><pft>@PROC_SPLIT_MST.PFT,</pft></display>
            <field action="import" tag="list">4000</field>
            <field action="replace" tag="9132"><pft>v131,v132</pft></field>
            <field action="replace" tag="9032"><pft>v32,if p(v9132) then ' Suppl',if v9132<>'0' then  ' ',v9132, fi, fi</pft></field>
            <field action="replace" tag="9032"><pft>if v9032='ahead' then 'In press' fi</pft></field>
            <field action="replace" tag="9014"><pft>if v9032='ahead' then '' else if p(v14^e) then v14^e else v14^f,if v14^l<>v14^f then |-|v14^l, fi fi fi</pft></field>
            <!-- Acta Ortop Bras. 2015;23(6):287-9 -->
            <display>
                <pft>
                '  <RELATED-DOC TYPE="'v4000^t'" PID="',v880,'"',| DOI="|v237|"|,'>'/,
                '	<ISSUE>'
              		,v30,' ',v65*0.4,';',v31,if p(v31) then |(|v9032|)| else v9032 fi,|: |v9014,
              	'</ISSUE>'/
              	'<DOCTITLE>',v12^*[1],'</DOCTITLE>'/
                '</RELATED-DOC>'/,
                </pft>
            </display>        
            <field action="export" tag="list">880</field>
        </loop>
    </do>
    
    <display>
        <pft>
        	,if a(v880) then
        		,'  <RELATED-DOC TYPE="',v4000^t,'"',' DOI="',v4000^*,'"/>'/,
        	,fi
        </pft>
    </display> 
    <label>END</label>
</function>

<function name="FindPIDbyExpression" action="replace" tag="4000">
	<do task="search">
		<parm name="db">ARTIGO</parm>
		<parm name="expression"><pft>v4000</pft></parm>
		<parm name="count">1</parm>

        <loop>
        	<display><pft>@PROC_SPLIT_MST.PFT,</pft></display>
        	<field action="replace"	tag="9880"><pft>v880</pft></field>
            <field action="export" tag="list">9880</field>
        </loop>
    </do>
    <field action="export" tag="list">9880</field>
</function>

<function name="FindPIDbyDOI" action="replace" tag="4000">
	<display><pft>'<!-- FindPIDbyDOI: ',v4000,' -->'/</pft></display>
	<do task="search">
		<parm name="db">ARTIGO</parm>
		<parm name="expression">|DOI=|v4000^*</parm>
		<parm name="count">1</parm>

        <loop>
        	<display><pft>@PROC_SPLIT_MST.PFT,</pft></display>
        	<field action="replace"	tag="9880"><pft>v880</pft></field>
            <field action="export" tag="list">9880</field>
        </loop>
    </do>
    <flow action="jump"><pft>if p(v9880) then 'FIM' fi</pft></flow>
	
    <do task="keyrange">
		<parm name="db">ARTIGO</parm>
		<parm name="from"><pft>'HR=',v4000^p*0.14,'9'</pft></parm>
		<parm name="to"><pft>'HR=',v4000^p*0.10</pft></parm>
		<parm name="reverse">On</parm>

		<field action="define" tag="4880">Isis_Key</field>
		<field action="define" tag="1003">Isis_Posting</field>
		<loop>
			<field action="import" tag="list">4000</field>
			<field action="replace" tag="237">
				<pft>ref(['ARTIGO']l(['ARTIGO'],v4880),@PROC_SPLIT_MST.PFT,v237)</pft>
			</field>
			
			<field action="replace" tag="9880">
				<pft>
					if v237=v4000^* then ref(['ARTIGO']l(['ARTIGO'],v4880),@PROC_SPLIT_MST.PFT,v880) fi
				</pft>
			</field>
			<field action="export" tag="list"><pft>if p(v9880) then '9880' fi</pft></field>
			<flow action="skip"><pft>if p(v9880) then 'Quit' fi</pft></flow>
		</loop>	
	</do>

    <label>FIM</label>
    <field action="export" tag="list">9880</field>
</function>

